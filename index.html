<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yimaginer.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="技术，人生，思考，自我">
<meta property="og:type" content="website">
<meta property="og:title" content="Focus2flow">
<meta property="og:url" content="https://yimaginer.github.io/index.html">
<meta property="og:site_name" content="Focus2flow">
<meta property="og:description" content="技术，人生，思考，自我">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="sky">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://yimaginer.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Focus2flow</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Focus2flow</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">less is more</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">sky</p>
  <div class="site-description" itemprop="description">技术，人生，思考，自我</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/15/mytest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/15/mytest/" class="post-title-link" itemprop="url">mytest</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-15 22:08:35 / 修改时间：22:15:00" itemprop="dateCreated datePublished" datetime="2024-09-15T22:08:35+08:00">2024-09-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <img src="/2024/09/15/mytest/image-20240915155128595.png" class="" title="This is an example image">
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/06/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/06/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" class="post-title-link" itemprop="url">动态规划</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-06 22:26:42 / 修改时间：22:27:12" itemprop="dateCreated datePublished" datetime="2024-09-06T22:26:42+08:00">2024-09-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="背包问题"><a href="#背包问题" class="headerlink" title="背包问题"></a>背包问题</h2><p>问题描述： n 个物体，每个物体重量价值分别为 w v , 在此基础上用承重为 W 的包去装物体，以使所装物体价值最大化。</p>
<ul>
<li>0-1 背包 ：每件物品最多用一次</li>
<li>完全背包：每件物品有无限个</li>
<li>多重背包：每个物品设置一个上限 s</li>
<li>分组背包：物品之间分成组，组内物品互斥选择</li>
<li>分析方法：  <ul>
<li><strong>状态表示</strong>：什么集合的什么属性</li>
<li><strong>状态计算</strong>：当前状态怎么由前置状态转移过来</li>
</ul>
</li>
</ul>
<h4 id="0-1-背包："><a href="#0-1-背包：" class="headerlink" title="0-1 背包："></a>0-1 背包：</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 朴素方法</span></span><br><span class="line"><span class="type">int</span> v[N];    <span class="comment">// 体积</span></span><br><span class="line"><span class="type">int</span> w[M];    <span class="comment">// 价值 </span></span><br><span class="line"><span class="type">int</span> f[N][M];  <span class="comment">// f[i][j], j体积下前i个物品的最大价值 </span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt;= m; j++)</span><br><span class="line">        <span class="keyword">if</span>(j &lt; v[i])  </span><br><span class="line">            f[i][j] = f[i - <span class="number">1</span>][j];</span><br><span class="line">        <span class="keyword">else</span>    </span><br><span class="line">            f[i][j] = <span class="built_in">max</span>(f[i - <span class="number">1</span>][j], f[i - <span class="number">1</span>][j - v[i]] + w[i]);</span><br><span class="line"><span class="comment">// 一维</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) </span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> j = m; j &gt;= v[i]; j--)  </span><br><span class="line">    	f[j] = <span class="built_in">max</span>(f[j], f[j - v[i]] + w[i]);	<span class="comment">// 选和不选，从上层转移过来，所以逆序</span></span><br><span class="line"><span class="comment">// 边输入边处理</span></span><br><span class="line">cin &gt;&gt; v &gt;&gt; w;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> j = m; j &gt;= v; j--)</span><br><span class="line">    f[j] = <span class="built_in">max</span>(f[j], f[j - v] + w);</span><br></pre></td></tr></table></figure>

<p>解：<a target="_blank" rel="noopener" href="https://www.acwing.com/solution/content/1374/">https://www.acwing.com/solution/content/1374/</a></p>
<p>分析方法：<a target="_blank" rel="noopener" href="https://www.acwing.com/problem/content/discussion/content/2807/">https://www.acwing.com/problem/content/discussion/content/2807/</a></p>
<h4 id="完全背包："><a href="#完全背包：" class="headerlink" title="完全背包："></a>完全背包：</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 朴素版本：o(nm*m)</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt;= m; j++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> k = <span class="number">0</span>; k * v[i] &lt;= j; k++)</span><br><span class="line">            f[i][j] = <span class="built_in">max</span>(f[i][j], f[i<span class="number">-1</span>][j-k*v[i]] + k*w[i]);</span><br><span class="line">    <span class="comment">//  为何括号中第一个是 f[i][j] 而不是 f[i-1][j]</span></span><br><span class="line">    <span class="comment">//  由于 k=0 必执行，这次执行确定性把 f[i][j] 赋值为 f[i-1][j]</span></span><br><span class="line"><span class="comment">// 观察现象：</span></span><br><span class="line">    <span class="comment">//  f[i][j] = max(f[i-1][j],f[i-1][j-v]+w,f[i-1][j-2v]+2w,f[i-1][j-3v]+3w,)</span></span><br><span class="line">    <span class="comment">//  f[i][j-v] = max(       ,f[i-1][j-v],  f[i-1][j-2v]+w ,f[i-1][j-3v]+2v,)</span></span><br><span class="line">    <span class="comment">//  f[i][j] = max(f[i-1][j],f[i][j-v]+w)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 由此，改进版本 O(nm)</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt;= m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        f[i][j] = f[i<span class="number">-1</span>][j];<span class="comment">//v[i] 之前，第 i 个物品放不进去，直接搬下来就行</span></span><br><span class="line">        <span class="keyword">if</span>(j&gt;=v[i]) f[i][j] = <span class="built_in">max</span>(f[i][j],f[i][j-v[i]]+w[i]);</span><br><span class="line">        <span class="comment">// 这次优化可以从上面的max计算的规律去想，也可以从f[i][j]依赖f[i][j-v[i]]去理解</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 至此，对比 0-1 背包和完全背包的转移方程</span></span><br><span class="line">    f[i][j] = <span class="built_in">max</span>(f[i<span class="number">-1</span>][j], f[i<span class="number">-1</span>][j-v[i]] + w[i])  <span class="comment">// 都是从上一行转移过来</span></span><br><span class="line">    f[i][j] = <span class="built_in">max</span>(f[i<span class="number">-1</span>][j], f[i][j-v[i]] + w[i])	<span class="comment">// 从上一行和同行的前置位过来，这里依赖同行的前置位，故不能倒序</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">// 3. 改进成一维 O(nm)</span></span><br><span class="line">   <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = v[i]; j &lt;= m; j++)</span><br><span class="line">		f[j] = <span class="built_in">max</span>(f[j],f[j-v[i]]+w[i]);     <span class="comment">// f[j-v[i]] 和 f[j] 有绝对的 w[i] 差值</span></span><br></pre></td></tr></table></figure>

<h4 id="多重背包："><a href="#多重背包：" class="headerlink" title="多重背包："></a>多重背包：</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 朴素解法 O(nmm)</span></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"><span class="type">int</span> v[N], w[N], s[N];</span><br><span class="line"><span class="type">int</span> f[N][N];</span><br><span class="line">    cin &gt;&gt; n &gt;&gt; m;</span><br><span class="line">    <span class="comment">// 1 开始，将数据录入和物品编号实际对应，虽然浪费一个空间</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span> ; i &lt;= n; i++) cin &gt;&gt; v[i] &gt;&gt; w[i] &gt;&gt; s[i];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt;= m; j++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> k = <span class="number">0</span>; k*v[i] &lt;= j &amp;&amp; k &lt;= s[i]; k++)</span><br><span class="line">                f[i][j] = <span class="built_in">max</span>(f[i][j], f[i<span class="number">-1</span>][j-k*v[i]] + k * w[i]); </span><br><span class="line"><span class="comment">// 2. 一维解法 O(nmm)</span></span><br><span class="line">f[i][j] = <span class="built_in">max</span>(f[i<span class="number">-1</span>][j],f[i<span class="number">-1</span>][j-v]+w,f[i<span class="number">-1</span>][j<span class="number">-2</span>v]<span class="number">+2</span>w,f[i<span class="number">-1</span>][j<span class="number">-3</span>v]<span class="number">+3</span>w,...,f[i<span class="number">-1</span>][j-sv]+sw)</span><br><span class="line">f[i][j-v]=<span class="built_in">max</span>(          f[i<span class="number">-1</span>][j-v],  f[i<span class="number">-1</span>][j<span class="number">-2</span>v]+w, f[i<span class="number">-1</span>][j<span class="number">-3</span>v]<span class="number">+2</span>w,...,f[i<span class="number">-1</span>][j-sv]+(s<span class="number">-1</span>)w,f[i<span class="number">-1</span>][j-(s<span class="number">+1</span>)v]+sw)</span><br><span class="line"><span class="comment">// 遗憾的是得知后面的最大值 f[i][j-v] ，并不能推知其子集f[i-1][j-v]+w,f[i-1][j-2v]+2w,f[i-1][j-3v]+3w,...,f[i-1][j-sv]+sw 的最大值，因此不能像完全背包一样依赖前置位。</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = m; j &gt;= <span class="number">0</span>; j--)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> k = <span class="number">0</span>; k &lt;= s[i]; k++)</span><br><span class="line">            <span class="keyword">if</span>(k*v[i]&lt;=j) f[j]=<span class="built_in">max</span>(f[j],f[j-k*v[i]]+k*w[i]);</span><br><span class="line"><span class="comment">// 3. 二进制拆分优化</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N = <span class="number">25000</span>, M = <span class="number">2010</span>;</span><br><span class="line"><span class="comment">//  25000来历：n,s取值都在2000之内，那么s个同类物品最多被分为log(s)组，也即最多11组，2000种物品算起来最多的组为2000*11</span></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"><span class="type">int</span> v[N], w[N]; <span class="comment">//逐一枚举最大是N*logS</span></span><br><span class="line"><span class="type">int</span> f[M]; <span class="comment">// 体积&lt;M</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cin &gt;&gt; n &gt;&gt; m;</span><br><span class="line">    <span class="type">int</span> cnt = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>;i &lt;= n;i ++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> a,b,s;</span><br><span class="line">        cin &gt;&gt; a &gt;&gt; b &gt;&gt; s;</span><br><span class="line">        <span class="type">int</span> k = <span class="number">1</span>; </span><br><span class="line">        <span class="keyword">while</span>(k&lt;=s) <span class="comment">// 按2的阶乘分组</span></span><br><span class="line">        &#123;</span><br><span class="line">            cnt ++ ; </span><br><span class="line">            v[cnt] = a * k ;</span><br><span class="line">            w[cnt] = b * k;</span><br><span class="line">            s -= k; </span><br><span class="line">            k *= <span class="number">2</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(s&gt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cnt ++ ;</span><br><span class="line">            v[cnt] = a*s; </span><br><span class="line">            w[cnt] = b*s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n = cnt ; </span><br><span class="line">    <span class="comment">//01背包一维优化</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>;i &lt;= n ;i ++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = m ;j &gt;= v[i];j --)</span><br><span class="line">            f[j] = <span class="built_in">max</span>(f[j],f[j-v[i]] + w[i]);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; f[m] &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分组背包："><a href="#分组背包：" class="headerlink" title="分组背包："></a>分组背包：</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 110</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">int</span> v[N][N],w[N][N];</span><br><span class="line"><span class="type">int</span> f[N],s[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cin &gt;&gt; n &gt;&gt; m;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        cin &gt;&gt; s[i];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; s[i]; j++)</span><br><span class="line">            cin &gt;&gt; v[i][j] &gt;&gt; w[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = m; j &gt;= <span class="number">0</span>; j--)</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> k = <span class="number">0</span>; k &lt; s[i]; k++)</span><br><span class="line">                <span class="keyword">if</span>(v[i][k] &lt;= j)</span><br><span class="line">                    f[j] = <span class="built_in">max</span>(f[j], f[j - v[i][k]] + w[i][k]);</span><br><span class="line">      </span><br><span class="line">    cout &lt;&lt; f[m] &lt;&lt; endl;     </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 采用一维时：数据依赖上一行，则倒序；依赖同一行前置位则正序。</span></span><br></pre></td></tr></table></figure>

<h2 id="线性DP"><a href="#线性DP" class="headerlink" title="线性DP"></a>线性DP</h2><h4 id="数字三角形-acwing-898"><a href="#数字三角形-acwing-898" class="headerlink" title="数字三角形 acwing 898"></a>数字三角形 <a target="_blank" rel="noopener" href="https://www.acwing.com/problem/content/description/900/">acwing 898</a></h4><ul>
<li>思路：<ul>
<li>状态表示（集合，属性）：到达任意坐标（i, j) 的路径和的最大值为 f[i][j]</li>
<li>状态转移 ： 这个最大值要么从左边转移过来，要么从右边转移过来，故 f[i][j] &#x3D; max(f[i -  1][j - 1] , f[i -  1][j]) +  a[i][j]</li>
</ul>
</li>
<li>其他注意事项：<ul>
<li>要想让三角形边界选到三角形内的数据，就要把 f 数组中三角形边界设置为负无穷</li>
<li>题目要求是到最底层，结果要在 f 数组的最后一行中找，极端情况下，所有元素都是最小值，累积出来的路径和会很小，因此，用于遍历最后一行的值也要设无穷小。</li>
<li>左右的坐标相对位置要找对</li>
</ul>
</li>
<li>其他解法：倒序遍历，相当于从底部走到顶部<a target="_blank" rel="noopener" href="https://www.acwing.com/solution/content/128359/">https://www.acwing.com/solution/content/128359/</a></li>
</ul>
<h4 id="最长上升子序列-acwing-895"><a href="#最长上升子序列-acwing-895" class="headerlink" title="最长上升子序列 acwing 895"></a>最长上升子序列 <a target="_blank" rel="noopener" href="https://www.acwing.com/activity/content/problem/content/1003/">acwing 895</a></h4><ul>
<li>思路1<ul>
<li>状态表示（集合，属性）：以 i 结尾的最长单调子序列长度为 f[i]</li>
<li>状态转移：遍历前面 i - 1个 f 数组元素，遇到 w[i] &gt; w[j] 则，f[i] &#x3D; max(f[i], f[j] +  1), 没遇到则 f[i] &#x3D;  1</li>
<li>时间复杂度：状态数(n) * 转移数(n)，O(n^2),</li>
</ul>
</li>
<li>思路2<ul>
<li>维护一个初始为空的递增序列 dp，遍历存储数组中的所有元素，找到其在递增序列中第一个大于等于其值的位置<ul>
<li>如果找到末尾，就在dp 末尾增加当前元素</li>
<li>如果是中间，就替换当前位置元素</li>
</ul>
</li>
<li>复杂度分析：O(nlogn) ，状态数(n) * 转移数(logn)</li>
<li>利用二分的解法： <a target="_blank" rel="noopener" href="https://www.acwing.com/solution/content/4807/">https://www.acwing.com/solution/content/4807/</a></li>
</ul>
</li>
</ul>
<h4 id="最长公共子序列-acwing-897"><a href="#最长公共子序列-acwing-897" class="headerlink" title="最长公共子序列 acwing 897"></a>最长公共子序列 <a target="_blank" rel="noopener" href="https://www.acwing.com/activity/content/problem/content/1005/">acwing 897</a></h4><ul>
<li>思路<ul>
<li>状态表示：f[i][j] A 的前 i 个字符， B 的前 j 个字符的公共子序列 的最长公共子序列</li>
<li>状态转移：f[i][j] 可以由以下四个状态变换过来：<ul>
<li>a[i],b[j] 均存在于 最长公共子序列中 (前提a[i]&#x3D;&#x3D;b[j])</li>
<li>a[i] 在，b[j] 不在   （无前提），不完全等同于  f[i][j - 1] </li>
<li>a[i],b[j] 均不在     （无前提）</li>
<li>a[i]不在，b[j]在     （无前提）</li>
</ul>
</li>
<li>更详细的分析：<a target="_blank" rel="noopener" href="https://www.acwing.com/solution/content/48820/">https://www.acwing.com/solution/content/48820/</a></li>
</ul>
</li>
</ul>
<h4 id="编辑距离"><a href="#编辑距离" class="headerlink" title="编辑距离"></a>编辑距离</h4><ul>
<li>思路<ul>
<li>状态表示</li>
<li>状态转移</li>
</ul>
</li>
</ul>
<h2 id="区间DP"><a href="#区间DP" class="headerlink" title="区间DP"></a>区间DP</h2><h4 id="石子合并"><a href="#石子合并" class="headerlink" title="石子合并"></a>石子合并</h4><h2 id="计数类DP"><a href="#计数类DP" class="headerlink" title="计数类DP"></a>计数类DP</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/%E9%9B%B7%E5%86%9B%E5%B9%B4%E5%BA%A6%E6%BC%94%E8%AE%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/%E9%9B%B7%E5%86%9B%E5%B9%B4%E5%BA%A6%E6%BC%94%E8%AE%B2/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-06 09:29:46" itemprop="dateCreated datePublished" datetime="2024-09-06T09:29:46+08:00">2024-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-19 20:56:04" itemprop="dateModified" datetime="2024-07-19T20:56:04+08:00">2024-07-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>34c: BBA系列入门款</p>
<p>人生值得被奖励，这就是dream car 的意义</p>
<p>订货目标：76000</p>
<p>定价：对标moudle3 21.59</p>
<p>保底10万，立正12万</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-06 09:29:46" itemprop="dateCreated datePublished" datetime="2024-09-06T09:29:46+08:00">2024-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-19 14:51:22" itemprop="dateModified" datetime="2024-07-19T14:51:22+08:00">2024-07-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>来自 dblp 搜索结果，<a target="_blank" rel="noopener" href="https://dblp.org/search?q=fuzz%20smart%20contract">https://dblp.org/search?q=fuzz%20smart%20contract</a></p>
<ol>
<li>ContractFuzz<strong>er:</strong> Fuzz<strong>ing</strong> Smart Contract<strong>s for Vulnerability Detection</strong></li>
<li><strong>Fuse: An Architecture for</strong> Smart Contract Fuzz <strong>Testing Service</strong></li>
<li><strong>Harvey: A Greybox</strong> Fuzz<strong>er for</strong> Smart Contract<strong>s</strong></li>
<li><strong>A</strong> Fuzz <strong>Testing Service for Assuring</strong> Smart Contract<strong>s</strong></li>
<li><strong>SoliAudit:</strong> Smart Contract <strong>Vulnerability Assessment Based on Machine Learning and</strong> Fuzz <strong>Testing</strong></li>
<li><strong>Robot Coalition Formation Based on</strong> Fuzz<strong>y Cooperative Games over Blockchain-Based</strong> Smart Contract<strong>s</strong></li>
<li>Fuzz<strong>y Cooperative Games Usage in</strong> Smart Contract<strong>s for Dynamic Robot Coalition Formation: Approach and Use Case Description</strong></li>
<li><strong>Efficient Funds Allocation System Based on</strong> Fuzz<strong>y Logic and</strong> Smart Contract<strong>s.</strong></li>
<li><strong>Learning to</strong> Fuzz <strong>from Symbolic Execution with Application to</strong> Smart Contract<strong>s.</strong></li>
<li><strong>EOSFuzzer:</strong> Fuzz<strong>ing EOSIO</strong> Smart Contract<strong>s for Vulnerability Detection</strong></li>
<li><strong>Towards</strong> Smart <strong>Hybrid</strong> Fuzz<strong>ing for</strong> Smart Contract<strong>s</strong></li>
<li><strong>sFuzz: An Efficient Adaptive</strong> Fuzz<strong>er for Solidity</strong> Smart Contract<strong>s</strong></li>
<li><strong>EthPloit: From</strong> Fuzz<strong>ing to Efficient Exploit Generation against</strong> Smart Contract<strong>s.</strong></li>
<li><strong>Testing Ethereum</strong> Smart Contract<strong>s: A Comparison of Symbolic Analysis and</strong> Fuzz <strong>Testing Tools</strong></li>
<li><strong>Echidna: effective, usable, and fast</strong> fuzz<strong>ing for</strong> smart contract<strong>s.</strong></li>
<li><strong>EOSFuzzer:</strong> Fuzz<strong>ing EOSIO</strong> Smart Contract<strong>s for Vulnerability Detection</strong></li>
<li><strong>sFuzz: an efficient adaptive</strong> fuzz<strong>er for solidity</strong> smart contract<strong>s</strong></li>
<li><strong>I Can Get Some Satisfaction:</strong> Fuzz<strong>y Ontologies for Partial Agreements in Blockchain</strong> Smart Contract<strong>s</strong></li>
<li><strong>GasFuzzer:</strong> Fuzz<strong>ing Ethereum</strong> Smart Contract <strong>Binaries to Expose Gas-Oriented Exception Security Vulnerabilities</strong></li>
<li>HFContractFuzzer: Fuzzing Hyperledger Fabric Smart Contracts for Vulnerability Detection. <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/ease/ease2021.html#DingLLZ21">EASE 2021</a>: 321-328</li>
<li>ConFuzzius: A Data Dependency-Aware Hybrid Fuzzer for Smart Contracts. <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/eurosp/eurosp2021.html#TorresIGS21">EuroS&amp;P 2021</a>: 103-119</li>
<li>echidna-parade: a tool for diverse multicore smart contract fuzzing.<a target="_blank" rel="noopener" href="https://dblp.org/db/conf/issta/issta2021.html#GroceG21">ISSTA 2021</a>: 658-661</li>
<li>SMARTIAN: Enhancing Smart Contract Fuzzing with Static and Dynamic Data-Flow Analyses.<a target="_blank" rel="noopener" href="https://dblp.org/db/conf/kbse/ase2021.html#0001K0GGC21">ASE 2021</a>: 227-239</li>
<li>Increasing Fuzz Testing Coverage for Smart Contracts with Dynamic Taint Analysis.<a target="_blank" rel="noopener" href="https://dblp.org/db/conf/qrs/qrs2021.html#JiDQGWW21">QRS 2021</a>: 243-247</li>
<li>Ambulance Vehicle Routing under Pandemic with Fuzzy Cooperative Game via Smart Contracts. <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/vehits/vehits2021.html#SmirnovT21">VEHITS 2021</a>: 538-545</li>
<li><strong>AntFuzzer: A Grey-Box</strong> Fuzz<strong>ing Framework for EOSIO</strong> Smart Contract<strong>s</strong></li>
<li><strong>TokenAuditor: Detecting Manipulation Risk in Token Smart Contract by Fuzzing.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/qrs/qrs2022.html#CaoZFHZ22">QRS 2022</a>: 651-662</li>
<li><strong>Effectively Generating Vulnerable Transaction Sequences in Smart Contracts with Reinforcement Learning-guided Fuzzing.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/kbse/ase2022.html#SuDZZL22">ASE 2022</a>: 36:1-36:12</li>
<li><strong>SynTest-Solidity: Automated Test Case Generation and Fuzzing for Smart Contracts.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/icse/icse2022c.html#OlsthoornSDP22">ICSE-Companion 2022</a>: 202-206</li>
<li><strong>Smart Contract Fuzzing for Enterprises: The Language Agnostic Way.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/comsnets/comsnets2022.html#PaniNPVMR22">COMSNETS 2022</a>: 1-6</li>
<li><strong>An Empirical Study on the Effects of Entry Function Pairs in Fuzzing Smart Contracts.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/compsac/compsac2022.html#AshrafC22">COMPSAC 2022</a>: 1716-1721</li>
<li><strong>Grey-box Fuzzing Based on Execution Feedback for EOSIO Smart Contracts.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/apsec/apsec2022.html#LiWYSFS22">APSEC 2022</a>: 1-10</li>
<li><strong>Privacy-preserving smart contracts for fuzzy WordNet-based document representation and clustering using regularised K-means method.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/journals/ijahuc/ijahuc40.html#ThathaBH22">Int. J. Ad Hoc Ubiquitous Comput. 40(1&#x2F;2&#x2F;3)</a>: 2-9 (2022)</li>
<li><strong>Are We There Yet? Unraveling the State-of-the-Art Smart Contract Fuzzers.</strong> <a target="_blank" rel="noopener" href="https://dblp.org/db/conf/icse/icse2024.html#Wu0YCJWLZ24">ICSE 2024</a>: 127:1-127:13</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/XP%E7%B3%BB%E7%BB%9F%E4%B8%8A%E5%81%9A%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/XP%E7%B3%BB%E7%BB%9F%E4%B8%8A%E5%81%9A%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-06 09:29:46" itemprop="dateCreated datePublished" datetime="2024-09-06T09:29:46+08:00">2024-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-19 15:16:23" itemprop="dateModified" datetime="2024-07-19T15:16:23+08:00">2024-07-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一个安全网课网站：<a target="_blank" rel="noopener" href="http://www.securitytube.net/groups?operation=view&groupId=5">SecurityTube</a>，年久失修，唯一价值可能是参照上面找资源</p>
<p>比如上面的一个在 XP SP3 平台漏洞利用的课在油管上的地址：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=f-1zIFb-zpw&list=PL6qa4C74KbMBo0BMM9ZdcFlDLkArwA3SF">Exploit Research Megaprimer</a></p>
<p>比如一个讲linux 汇编的课：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=K0g-twyhmQ4&list=PLyqno_bgl3e-zLBZGdi_zsPQYPQUlZYe4">Assembly Primer For Hackers </a></p>
<p>但是这样的课或许不一定非要在这里学</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-06 09:25:57" itemprop="dateCreated datePublished" datetime="2024-09-06T09:25:57+08:00">2024-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-19 14:19:28" itemprop="dateModified" datetime="2024-07-19T14:19:28+08:00">2024-07-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>符号执行：在好情况下做到最好 — Atredis Partners</strong></p>
<p>符号执行有时会被误解。通用的符号执行工具在面对足够复杂的目标时，很难证明其价值。然而，我发现在某些特定的情况下，符号执行可以非常有帮助。其中一种情况是在处理来自模糊测试器的大量崩溃时，尤其是在处理复杂或不透明的目标时。这就是我之前遇到的“好情况”，我的模糊测试器给了我大量的崩溃，这些崩溃抵抗了常规的最小化和去重。通过构建一个小型的符号调试器，我管理了一个从模糊测试案例到完全理解的更快的响应时间。</p>
<p>在这篇文章中，我想分享我为崩溃分类编写符号执行工具的过程，并尝试突出我使用的一些技巧，使工具更有效和灵活。这里的例子都使用了伟大的<a target="_blank" rel="noopener" href="https://triton-library.github.io/">Triton</a>库来进行我们的象征执行和求解。所有示例的代码都托管在：<a target="_blank" rel="noopener" href="https://github.com/atredis-jordan/SymbolicTriagePost">github.com&#x2F;atredis-jordan&#x2F;SymbolicTriagePost</a></p>
<blockquote>
<p>（顺便说一下，我们有一个课程！）你是否在你的工作流程中进行逆向工程和符号执行，或者想要这样做？</p>
<p>你是否正在使用模糊测试，但希望找到更多机会来改进它，并发现更深入、更有趣的漏洞？</p>
<p>你能否在网络空间与控制台牛仔一起混？</p>
<p>我们开发了一个为期4天的课程，名为“实用符号执行用于VR和RE”，专为这些目标量身定制。它既有趣又实用，有很多演示和实验室，让你练习以创造性的方式应用这些概念。如果你对此感兴趣，可以在本文底部找到更多信息。希望在那里见到你！</p>
</blockquote>
<p>我们将使用_Procmon64.exe_中的一堆崩溃作为我们的示例。Procmon解析PML（进程监视器日志）文件非常容易出错，我们可以在短时间内从模糊测试会话中快速获得大量崩溃。它是一个大型的不透明二进制文件，崩溃具有一些非确定性，因此有用的工具将帮助我们加快逆向工程的努力。请注意，我们并没有尝试在Procmon中找到漏洞；因此，尽管我们将在这里讨论的这些漏洞对攻击者来说似乎并不特别有用，但我也不会在不久的将来打开任何不受信任的PML文件。</p>
<p>我通过制作一些非常小的PML文件并将Jackalope对准目标，收集了一堆崩溃。几个小时后，我们有大约200个奇怪的崩溃可以玩。许多崩溃是不稳定的，偶尔才会重现。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..\\Jackalope\\Release\\fuzzer.exe -iterations_per_round 30 -minimize_samples false -crash_retry 0 -nthreads 32 -in - -resume -out .\\out -t 5000 -file_extension PML -instrument_module procmon64.exe -- procmon64.exe /OpenLog @@ /Quiet /Runtime 1 /NoFilter /NoConnect</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用Jackalope对Procmon的PML解析器进行模糊测试</p>
</blockquote>
<h2 id="一个简单的调试器"><a href="#一个简单的调试器" class="headerlink" title="一个简单的调试器"></a>一个简单的调试器</h2><p>在所有这些符号执行的炒作中，我们的第一步是不要使用符号执行！知道何时转向符号执行，何时仅使用仿真或调试器是一个好技能。在这种情况下，我们将编写一个非常简单的调试器，使用Windows调试API。这个调试器可以用来重新运行我们的崩溃输入，找出它们的稳定性，看看它们是否都发生在主线程中，收集堆栈跟踪等。</p>
<p>此外，拥有一个程序化调试器在我们开始符号执行时将非常有用。我们将在稍后讨论这个问题，首先让我们的调试器启动。</p>
<blockquote>
<p>快速旁注。我这里所有的代码示例都是用Python编写的，因为我喜欢在调试器中能够进入IPython。我在<a target="_blank" rel="noopener" href="https://github.com/atredis-jordan/SymbolicTriagePost/blob/main/win_types.py">win_types.py</a>文件中定义了一堆ctypes结构。我建议有一些程序化的方式来生成你需要的类型。可以查看<a target="_blank" rel="noopener" href="https://github.com/horsicq/PDBRipper">PDBRipper</a>或<a target="_blank" rel="noopener" href="https://github.com/microsoft/microsoft-pdb/blob/master/cvdump/cvdump.exe">cvdump</a>作为一个好的开始。</p>
</blockquote>
<p>好的，所以我们首先想要一个调试器，可以运行进程直到它崩溃并收集异常信息。基本前提是我们开始一个被调试的进程（我们在<a target="_blank" rel="noopener" href="https://github.com/atredis-jordan/SymbolicTriagePost/blob/main/triage.py#L77">triage.py中的_connect_debugger_函数</a>），然后等待它直到我们得到一个未处理的异常。像这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">handle, main_tid = connect_debugger(cmd)</span><br><span class="line"></span><br><span class="line">log(<span class="string">&quot;process&quot;</span>, <span class="number">3</span>, <span class="string">f&quot;: -- &quot;</span>)</span><br><span class="line"></span><br><span class="line">event = dbg_wait(handle, <span class="literal">None</span>)</span><br><span class="line">code = event.dwDebugEventCode</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> code == EXIT_PROCESS_DEBUG_EVENT:</span><br><span class="line">    log(<span class="string">&quot;crash&quot;</span>, <span class="number">1</span>, <span class="string">f&quot; Closed with no crash&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> code == EXCEPTION_DEBUG_EVENT:</span><br><span class="line">    <span class="comment"># 需要调查的异常</span></span><br><span class="line">    log(<span class="string">&quot;crash&quot;</span>, <span class="number">1</span>, <span class="string">f&quot; crashed:&quot;</span>)</span><br><span class="line">    er = event.u.Exception.ExceptionRecord</span><br><span class="line">    log(<span class="string">&quot;crash&quot;</span>, <span class="number">1</span>, exceptionstr(handle, er, event.dwThreadId))</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    log(<span class="string">&quot;process&quot;</span>, <span class="number">1</span>, <span class="string">f&quot; hit unexpected Debug Event &quot;</span>)</span><br><span class="line"></span><br><span class="line">dbg_kill(handle)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>triage.py的handle_case的一部分，运行单个测试案例</p>
</blockquote>
<p><img src="https://images.squarespace-cdn.com/content/v1/576323cfd482e984e113fe9c/1325b83b-f8de-419b-b515-2802b291355d/crash.png" alt="img"></p>
<p><em>运行上述代码以获取崩溃的异常信息</em></p>
<p>许多崩溃不会每次都发生，因为某些非确定性。在我们的调试器中多次运行所有测试案例，我们可以构建一个最稳定的崩溃的图景，如果它们保持在主线程中，以及发生了什么类型的异常。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx008_00000xxxxxxxx5AA_1.PML -- 100% (18) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x520 read at 0x5aa</span><br><span class="line">        EXCEPTION_STACK_BUFFER_OVERRUN(0xc0000409) @ 0x83c</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx008_00000xxxxxxxx5AA_2.PML -- 100% (34) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x520 read at 0x5aa</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx063_00000xxxxxxxx3ED_1.PML -- 100% (34) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x520 read at 0x3ed</span><br><span class="line">...</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx3D4_00000xxxxxxxxED1_2.PML -- 52% (23) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x87a read at 0xed1</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx234_00000xxxxxxxxED4_3.PML -- 45% (22) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x649 read at 0xa2</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x87a read at 0xed4</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx3CA_00000xxxxxxxxED1_1.PML -- 45% (22) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x87a read at 0xed1</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx5EC_00000xxxxxxxx0A2_1.PML -- 45% (22) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x87a read at 0xed4</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx5EF_00000xxxxxxxxF27_1.PML -- 45% (22) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x649 read at 0xa2</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x87a read at 0xecb</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxxB46_00000xxxxxxxxFF4_1.PML -- 44% (18) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x87a read at 0xed4</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x649 read at 0xa2</span><br><span class="line">.\\crsh\\access_violation_0000xxxxxxxxx25A_00000xxxxxxxxED4_1.PML -- 38% (21) -- main thread</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x649 read at 0xa2</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x87a read at 0xecb</span><br><span class="line">        EXCEPTION_ACCESS_VIOLATION(0xc0000005) @ 0x19d read at 0x184</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从多次运行中收集的信息</p>
</blockquote>
<blockquote>
<p>让我再快速旁注一下。Windows异常很棒，因为它们可以包含额外的信息。异常记录告诉我们访问违规是读取还是写入，以及导致故障的指针。在Linux上，这很难以编程方式获取，因为SEGFAULT只是一个SEGFAULT。在这里，我们可以使用我们的符号执行引擎仅提升出错的指令。引擎将为我们提供有关发生什么加载或存储的缺失信息，让我们区分无聊的NULL读取和令人兴奋的超出页面末尾的写入。</p>
</blockquote>
<h2 id="让我们的符号执行运行起来，以及一些技巧"><a href="#让我们的符号执行运行起来，以及一些技巧" class="headerlink" title="让我们的符号执行运行起来，以及一些技巧"></a>让我们的符号执行运行起来，以及一些技巧</h2><p>现在我们有一个使用Windows调试API（或_ptrace_或任何其他）的简单调试器。现在我们可以将我们的符号引擎混合到其中。计划是使用我们的调试器运行目标，直到我们的输入在某个地方的内存中。然后我们将输入标记为符号，并在我们的符号引擎中跟踪其余的指令。</p>
<blockquote>
<p>将输入标记为“符号”这里意味着我们正在告诉我们的引擎这些值将被跟踪为变量，而不仅仅是数字。这将让我们看到的所有表达式都是以我们的输入变量的形式，比如“rax: (add INPUT_12 0x12)”而不是只是“rax: 0x53”。一个更好的术语可能是“混合的”（具体-符号），因为我们仍然使用这些输入字节的实际值，只是在它们上面添加了符号信息。不过，我在这篇文章中还是使用了符号这个术语。</p>
</blockquote>
<p>我们的调试器会告诉我们何时到达异常。从那里我们可以在崩溃时的状态中检查我们符号输入的信息。对于访问违规，我们希望能够看到被解引用的指针是符号的“_(0xwhatever + INPUT_3c)_”或其他一些符号表达式，显示我们的输入中是什么导致了崩溃。</p>
<p>这些信息对于根本原因分析崩溃（我们将在下一节中看到一些处理这些信息的很酷的技巧）非常有用。我们收集这些符号信息，这样我们就可以利用保持我们在崩溃路径上的约束，以及我们自己的约束，并将这些发送到求解器。使用求解器，我们可以问“什么输入会使这个指针变成X？”这让我们能够快速识别一个Write-What-Where从Read8-AroundHere，或者一个Write-That-ThereGiveOrTake100。我们可以在跟踪的任何点中断我们的象征性调试器，并使用求解器来回答我们的问题。</p>
<p><img src="https://images.squarespace-cdn.com/content/v1/576323cfd482e984e113fe9c/41d0f85f-c26e-4c2e-9ae9-ba6e318403c6/check_value.png" alt="img"></p>
<p><em>在断点处停止，并看到什么输入会使RBX等于0x12340000</em></p>
<p>注意：我应该指出，严格来说，使用调试器并不是必需的。我们可以只加载_procmon64.exe_及其库到我们的象征执行引擎中，然后在没有调试器的帮助下模拟指令。如果你看到<a target="_blank" rel="noopener" href="https://github.com/JonathanSalwan/Triton/tree/master/src/examples">Triton存储库中的伟大示例</a>，你会注意到它们没有跟随调试器步骤。我喜欢将符号执行引擎与调试器一起使用有几个原因。我将在以下段落中突出其中一些原因。</p>
<p>主要原因可能是为了避免自己被误导。有了调试器或具体执行跟踪，我可以跟随一个我可以跟随的真实情况。没有它，当我在设置我们的执行环境时犯错误时，很容易直到后来才意识到。比如不正确地加载库、处理重定位或在Windows上设置_TEB_和_PEB_。通过使用调试器，我们可以通过从实际进程中拉取内存块来设置我们的执行环境。我们还可以按需加载内存，这样我们可以在非常大的进程上节省时间。在<a target="_blank" rel="noopener" href="https://github.com/atredis-jordan/SymbolicTriagePost/blob/main/triage.py#L643">我们的示例中</a>，我们使用Triton的_GET&#x2F;SET_CONCRETE_MEMORY_VALUE_回调懒加载内存。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tri_init</span>(<span class="params">handle, onlyonsym=<span class="literal">False</span>, memarray=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="comment"># 进行TritonContext的基本初始化</span></span><br><span class="line"></span><br><span class="line">    ctx = TritonContext(ARCH.X86_64)</span><br><span class="line">    ctx.setMode(MODE.ONLY_ON_SYMBOLIZED, onlyonsym)</span><br><span class="line">    <span class="keyword">if</span> memarray:</span><br><span class="line">        ctx.setMode(MODE.MEMORY_ARRAY, <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ctx.setMode(MODE.ALIGNED_MEMORY, <span class="literal">True</span>)</span><br><span class="line">    ctx.setMode(MODE.AST_OPTIMIZATIONS, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置延迟内存加载</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getmemcb</span>(<span class="params">ctx, ma</span>):</span><br><span class="line">        addr = ma.getAddress()</span><br><span class="line">        sz = ma.getSize()</span><br><span class="line">        <span class="comment"># 只会加载之前没有加载过的页面</span></span><br><span class="line">        tri_load_dbg_mem(ctx, handle, addr, sz, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setmemcb</span>(<span class="params">ctx, ma, val</span>):</span><br><span class="line">        addr = ma.getAddress()</span><br><span class="line">        sz = ma.getSize()</span><br><span class="line">        <span class="comment"># 只会加载之前没有加载过的页面</span></span><br><span class="line">        tri_load_dbg_mem(ctx, handle, addr, sz, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    ctx.addCallback(CALLBACK.GET_CONCRETE_MEMORY_VALUE, getmemcb)</span><br><span class="line">    ctx.addCallback(CALLBACK.SET_CONCRETE_MEMORY_VALUE, setmemcb)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctx</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在triage.py中设置Triton</p>
</blockquote>
<p>调试器还让我们处理我们的象征执行引擎不知道的指令。例如，Triton没有定义’<em>rdrand</em>‘指令。通过与我们的调试器单步执行，我们可以在遇到未知指令时简单地修正任何更改的寄存器。这可能会导致如果我们的符号输入与指令一起做某些事情时，符号信息的丢失，但大多数情况下我们可以忽略这些指令。</p>
<p>最后，使用我们的调试器给我们带来了另一个非常好的好处；我们可以跳过整个无关代码的区域！我们必须非常小心地标记什么为无关，因为做错了可能意味着我们失去了很多符号信息。对于procmon，我将大部分绘图代码标记为无关。当从user32或gdi32中击中这些导入之一时，我们放置一个断点并让调试器跨过这些调用，然后恢复与Triton的单步执行。这节省了大量的时间，因为符号执行比实际执行慢了几个数量级。我们可以跨过的任何无关代码都可以产生巨大的差异。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 跳过绘图代码</span></span><br><span class="line"><span class="keyword">if</span> skip_imports:</span><br><span class="line">    impfuncs = dbg_get_imports_from(handle, base, [<span class="string">&quot;user32.dll&quot;</span>, <span class="string">&quot;gdi32.dll&quot;</span>, <span class="string">&quot;comdlg32.dll&quot;</span>, <span class="string">&quot;comctl32.dll&quot;</span>])</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> impfuncs:</span><br><span class="line">        addr = impfuncs[name]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 不跳过一些user32的</span></span><br><span class="line">        skip = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> ds <span class="keyword">in</span> [<span class="string">&quot;PostMessage&quot;</span>, <span class="string">&quot;DefWindowProc&quot;</span>, <span class="string">&quot;PostQuitMessage&quot;</span>, <span class="string">&quot;GetMessagePos&quot;</span>, <span class="string">&quot;PeekMessage&quot;</span>, <span class="string">&quot;DispatchMessage&quot;</span>, <span class="string">&quot;GetMessage&quot;</span>, <span class="string">&quot;TranslateMessage&quot;</span>, <span class="string">&quot;SendMessage&quot;</span>, <span class="string">&quot;CallWindowProc&quot;</span>, <span class="string">&quot;CallNextHook&quot;</span>]:</span><br><span class="line">            <span class="keyword">if</span> ds.lower() <span class="keyword">in</span> name.lower():</span><br><span class="line">                skip = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> skip:</span><br><span class="line">            hooks[addr] = (skipfunc_hook, name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在triage.py中跳过不需要的导入</p>
</blockquote>
<p>对于我们的目标，跳过导入还不够。我们仍然在procmon二进制文件中的循环中花费大量时间。快速查看确认这些是静态包含的_memset_和_memcpy_。我们不能只是跳过_memcpy_，因为我们会失去正在复制的符号信息。因此对于这两个，我们编写了一个钩子，会在Python中以符号方式处理操作，而不必模拟每条指令。我们确保复制的字节在源数据中获得了符号表达式的副本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">    sa = MemoryAccess(src + i, <span class="number">1</span>)</span><br><span class="line">    da = MemoryAccess(dst + i, <span class="number">1</span>)</span><br><span class="line">    cell = ctx.getMemoryAst(sa)</span><br><span class="line">    expr = ctx.newSymbolicExpression(cell, <span class="string">&quot;memcpy byte&quot;</span>)</span><br><span class="line">    ctx.assignSymbolicExpressionToMemory(expr, da)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在我们的memcpy钩子中传输符号信息</p>
</blockquote>
<p>这些类型的钩子不仅节省了我们的时间，而且是一个检查_memcpy_或_memset_中符号参数的绝佳机会。即使当前跟踪不会在_memcpy_中崩溃，我们也有能力查看这些符号参数并询问“这个_memcpy_能否到达未映射的内存？”或者“大小参数是否不合理地大？”。这可以帮助我们找到其他漏洞，或者我们已经跟踪的问题的其他表达方式。以下是一个小检查，试图看看_memcpy_的目的地的结尾是否可以很远。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">astctx = ctx.getAstContext()</span><br><span class="line">cond = ctx.getPathPredicate()</span><br><span class="line"><span class="comment"># dst + size</span></span><br><span class="line">dstendast = ctx.getRegisterAst(ctx.registers.rcx) + ctx.getRegisterAst(ctx.registers.r8)</span><br><span class="line"><span class="comment"># dst + size的具体值</span></span><br><span class="line">dstendcon = dst + size</span><br><span class="line">testpast = <span class="number">0x414141</span></span><br><span class="line">cond = astctx.land([cond, (dstendcon + testpast) &lt;= dstendast])</span><br><span class="line"></span><br><span class="line">log(<span class="string">&quot;hook&quot;</span>, <span class="number">5</span>, <span class="string">&quot;Trying to solve for a big memcpy&quot;</span>)</span><br><span class="line">model, status, _ = ctx.getModel(cond, <span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span> status == SOLVER_STATE.SAT:</span><br><span class="line">    <span class="comment"># 可以走那么远</span></span><br><span class="line">    <span class="comment"># 这可能不是我们崩溃的原因，所以让我们只是报告它，而不是引发它</span></span><br><span class="line">    log(<span class="string">&quot;crash&quot;</span>, <span class="number">2</span>, <span class="string">&quot;Symbolic memcpy could go really far!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在triage.py的memcpy钩子中的一个简单检查</p>
</blockquote>
<p>这些检查的权衡是经常调用求解器可能会增加我们的运行时间，你可能不希望它们一直启用。</p>
<p>到目前为止，我们已经拥有了运行我们的崩溃案例并开始去重和根本原因分析所需的大部分内容。然而，我们的一些访问违规仍然表示错误的解引用不依赖于我们的输入。这对我来说没有意义，因此我怀疑我们在某个地方丢失了符号信息。有时这可能由于指针的具体化而发生，因此打开Triton的新_MEMORY_ARRAY_模式可以帮助我们恢复该信息（以速度为代价）。</p>
<p>在这种情况下，我让我的工具在跟踪过程中打印出所有被调用的导入函数。我想看看路径上的任何系统调用是否会导致符号信息的丢失。或者是否有一个调用重新引入了输入而没有被符号化。我发现还有一个对_MapViewOfFile_的第二个调用，它将我们的输入文件重新映射到内存中的另一个位置。通过<a target="_blank" rel="noopener" href="https://github.com/atredis-jordan/SymbolicTriagePost/blob/main/triage.py#L861">添加一个钩子</a>来符号化重新映射的输入，现在所有的崩溃都正确地报告了它们与输入的符号关系！</p>
<p><img src="https://images.squarespace-cdn.com/content/v1/576323cfd482e984e113fe9c/7a06203f-edfd-4b81-816a-99f01c6d8a79/crashast.png" alt="img"></p>
<p><em>我们的工具显示了一个坏解引用的AST</em></p>
<h2 id="使用我们的象征性调试器"><a href="#使用我们的象征性调试器" class="headerlink" title="使用我们的象征性调试器"></a>使用我们的象征性调试器</h2><p>酷！现在我们有了我们崩溃的符号信息。我们用它做什么？</p>
<p>首先，我们可以快速根据它们依赖的输入将我们的崩溃进行分组。这非常有帮助；即使一些问题可能导致多个位置的崩溃，我们仍然可以根据确切的输入缺乏边界检查将它们组合在一起。这可以帮助我们更好地理解一个错误，并看到错误与系统的不同交互方式。</p>
<p>通过分组我们的崩溃，看起来我们的200个左右的崩溃可以归结为四个不同的组：三个被控制的指针被读取和一个调用___fastfail_。</p>
<p>Triton给我们的一个很酷的工具是反向切片！因为Triton在构建它的符号表达式时可以保持与相关指令的引用，我们可以生成一个只包含与我们最终表达式相关的指令的指令跟踪。我使用这个来削减大部分代码作为无关的，并能够只走输入和崩溃之间的相关代码片段。以下是我们收集的有关一个崩溃中被解引用的坏指针的相关指令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">backslice_expr</span>(<span class="params">ctx, symbexp, print_expr=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="comment"># 按refId排序以按时间顺序</span></span><br><span class="line">    <span class="comment"># 从加载访问中获取符号表达式，可以这样做：</span></span><br><span class="line">    <span class="comment"># symbexp = inst.getLoadAccess()[0][0].getLeaAst().getSymbolicExpression()</span></span><br><span class="line">    items = <span class="built_in">sorted</span>(ctx.sliceExpressions(symbexp).items(), key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">for</span> _, expr <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">if</span> print_expr:</span><br><span class="line">            <span class="built_in">print</span>(expr)</span><br><span class="line">        da = expr.getDisassembly()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(da) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\t&quot;</span> <span class="keyword">if</span> print_expr <span class="keyword">else</span> <span class="string">&quot;&quot;</span>, da)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>triage.py中的一个反向切片助手</p>
</blockquote>
<p><img src="https://images.squarespace-cdn.com/content/v1/576323cfd482e984e113fe9c/8f5fd529-b03a-4a4a-8527-1d29f63cfa2c/backslice_sm.png" alt="img"></p>
<p><em>使用上述代码进行反向切片</em></p>
<p>能够在跟踪的任何点进入IPython REPL并看到程序状态以我的输入为依据在我的RE过程中非常有帮助。</p>
<p>对于调用___fastfail_（有点像Windows的_abort_），我们这里没有坏解引用来进行反向切片，相反我们有我们的引擎收集的路径约束。这些约束是任何时候引擎看到我们可以在交叉路口象征性地走两条路时捕获的。为了保持与我们的具体路径的联系，引擎记录了我们路径所需的条件。例如：如果我们在将INPUT_5字节与0比较后采取了一个_jne_分支，引擎将添加一个路径约束，说“如果你想继续我们走的路径，请确保INPUT_5不是0”，或者用AST的话说“_(not (&#x3D; INPUT_5 (_ bv0 8))_)”。</p>
<p>这些路径约束非常有用。我们可以使用它们来生成其他输入，这些输入会走未探索的路径。有很多不错的符号执行工具使用这个来帮助模糊测试器生成有趣的新输入。（<a target="_blank" rel="noopener" href="https://github.com/eurecom-s3/symcc">SymCC</a>、<a target="_blank" rel="noopener" href="http://klee.github.io/">KLEE</a>、<a target="_blank" rel="noopener" href="https://github.com/shellphish/driller">Driller</a>，举三个例子）</p>
<p>在我们的情况下，我们可以检查它们来找出为什么我们最终到达了___fastfail_。通过仅查看最近的路径约束，我们可以看到由于我们的输入，我们的路径最近在哪里分叉。</p>
<p><img src="https://images.squarespace-cdn.com/content/v1/576323cfd482e984e113fe9c/3ce16869-7e3a-4bf6-8aa5-8ed45016f63c/abort_constraint.png" alt="img"></p>
<p><em>导致___fastfail_的最最近的路径约束</em></p>
<p><img src="https://images.squarespace-cdn.com/content/v1/576323cfd482e984e113fe9c/00f6dda5-90e0-4f16-b572-391f25baf398/constraint_path.png" alt="img"></p>
<p><em>最最近的路径约束周围的汇编</em></p>
<p>路径约束告诉我们，上面的汇编中的条件跳转在_0x7FF7A3F43517_是我们的路径由于我们的输入值而最后一次分叉的地方。当我们在分叉后跟踪路径时，我们可以看到它总是直接导致我们的致命条件。为了获取更多关于分叉前的比较失败的信息，我为我们在该连接处进入了一个IPython shell。我们的工具使我们可以轻松地确定我们在分支前解引用的RCX指针的控制。这使这成为另一个由于控制指针读取而导致的崩溃。</p>
<p>显示分支前解引用寄存器的AST</p>
<h2 id="从这里去哪里"><a href="#从这里去哪里" class="headerlink" title="从这里去哪里"></a>从这里去哪里</h2><p>所以从这里我们对_procmon64.exe_中存在的问题有了一个很好的理解。更深入地研究崩溃显示它们可能不适用于制作恶意PML文件。如果我想继续走这条路，我的下一步将包括：</p>
<ul>
<li>根据已知的输入中未检查的区域为我们的模糊测试器生成有趣的测试案例</li>
<li>识别我们利用路径中看起来很有吸引力的函数。有了我们的工具，我们可以收集有关我们在这些函数中拥有的控制的信息。有了这些信息，我们可以开始路径探索或生成遵循我们对看起来有趣的区域的直觉的模糊测试案例。</li>
<li>修补不感兴趣的崩溃位置，并让我们的模糊测试器在不被低挂的果实阻止的情况下找到更好的路径。</li>
<li><a target="_blank" rel="noopener" href="https://forum.spacehey.com/topic?id=93101">为了好玩，生成一个非常小的崩溃输入</a>。</li>
</ul>
<p>微软的官方政策是“所有Sysinternals工具都是‘按原样’提供的，没有官方的微软支持。”我们未能找到一个合适的地方来报告这些问题。如果任何与Sysinternals套件有联系的人想要更多信息，请与我们联系。</p>
<h2 id="希望这有所帮助！来参加课程吧！"><a href="#希望这有所帮助！来参加课程吧！" class="headerlink" title="希望这有所帮助！来参加课程吧！"></a>希望这有所帮助！来参加课程吧！</h2><p>我希望这篇文章能帮助你看到创造性的符号执行工具如何帮助他们的工作流程！如果有人有任何问题或想要谈论它，可以通过@jordan9001或<a href="mailto:&#x6a;&#x6f;&#114;&#x64;&#x61;&#110;&#46;&#x77;&#x68;&#105;&#116;&#x65;&#x68;&#101;&#97;&#x64;&#64;&#97;&#x74;&#114;&#x65;&#100;&#x69;&#x73;&#x2e;&#x63;&#111;&#109;">&#x6a;&#x6f;&#114;&#x64;&#x61;&#110;&#46;&#x77;&#x68;&#105;&#116;&#x65;&#x68;&#101;&#97;&#x64;&#64;&#97;&#x74;&#114;&#x65;&#100;&#x69;&#x73;&#x2e;&#x63;&#111;&#109;</a>给我发消息。</p>
<p>如果你读到了这篇文章的最后，你可能会喜欢我们的课程！</p>
<p>“实用符号执行用于VR和RE”是动手的。制作它我有很多乐趣，我们查看了应用这些概念的各种方式。学生们花时间熟悉一些框架，去混淆二进制文件，检测检查时间-使用时间的漏洞，以及其他有趣的事情。</p>
<p>你可以在下面提供你的信息，我们将在下次提供公开课程时通过电子邮件通知你。（没有垃圾邮件或其他任何东西，我保证。）</p>
<p>如果你有一个团队对接受这种培训感兴趣，也可以与我们联系，我们也可以私下提供这种培训！我希望有一天能在课堂上见到你！</p>
<p>谢谢！</p>
<p>我们尊重你的隐私，不会将你的联系信息用于除Atredis培训新闻之外的任何其他用途。</p>
<p>谢谢！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/libfuzz%E6%8B%93%E8%8D%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/libfuzz%E6%8B%93%E8%8D%92/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-06 09:25:44" itemprop="dateCreated datePublished" datetime="2024-09-06T09:25:44+08:00">2024-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-19 14:53:33" itemprop="dateModified" datetime="2024-07-19T14:53:33+08:00">2024-07-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>libfuzz：</p>
<p>LibAFL github 仓库：<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/LibAFL">https://github.com/AFLplusplus/LibAFL</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=3RWkT1Q5IV0">Fuzzers Like Lego @rC3 - YouTube</a>中讲到：没有最好的 fuzzer,只有针对使用常见特异性改造的 fuzzer 才是好 fuzzer, AFL 作为奠基石，但是在各个环节都是由改进空间的。</p>
<p>另一个pre:<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=PWB8GIhFAaI">LibAFL: The Advanced Fuzzing Library - Andrea Fioraldi &amp; Dominik Maier @FuzzCon Europe 2021</a></p>
<p>libfuzz 文档介绍：<a target="_blank" rel="noopener" href="https://aflplus.plus/libafl-book/getting_started/crates.html">Crates - The LibAFL Fuzzing Library (aflplus.plus)</a></p>
<p>fuzz101实验：<a target="_blank" rel="noopener" href="https://epi052.gitlab.io/notes-to-self/blog/2021-11-01-fuzzing-101-with-libafl/">fuzz101</a></p>
<ul>
<li>“LibAFL 书籍”是由一些 LibAFL 维护者创建的，是一个很好的资源。<a target="_blank" rel="noopener" href="https://aflplus.plus/libafl-book/">https://aflplus.plus/libafl-book/</a></li>
<li>epi 有一系列很棒的文章，深入探讨了使用 LibAFL 创建一些示例模糊测试器的过程。<a target="_blank" rel="noopener" href="https://epi052.gitlab.io/notes-to-self/blog/2021-11-01-fuzzing-101-with-libafl/">https://epi052.gitlab.io/notes-to-self/blog/2021-11-01-fuzzing-101-with-libafl/</a></li>
<li>LibAFL 仓库本身包含许多有用的示例，可以作为你自己模糊测试器的参考。<a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/LibAFL/tree/main/fuzzers">https://github.com/AFLplusplus/LibAFL/tree/main/fuzzers</a></li>
</ul>
<p>NYX官网：<a target="_blank" rel="noopener" href="https://nyx-fuzz.com/">Nyx (nyx-fuzz.com)</a></p>
<p>NYX一个 pre:<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=f5uhWesvjZ8">Thorsten Holz - Fuzz Testing and Beyond (youtube.com)</a></p>
<p>欠缺的知识图谱：</p>
<p>符号执行</p>
<p>污点分析</p>
<p>qemu模式</p>
<p>asan</p>
<p>frada</p>
<p>实操：</p>
<p>漏洞复现</p>
<p>gdb调试</p>
<p>ida使用</p>
<p>逆向能力</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/rust%E8%AF%AD%E8%A8%80%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%90%91%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/06/%E5%BE%85%E5%A4%84%E7%90%86/rust%E8%AF%AD%E8%A8%80%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%90%91%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-06 09:25:03" itemprop="dateCreated datePublished" datetime="2024-09-06T09:25:03+08:00">2024-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-19 12:24:04" itemprop="dateModified" datetime="2024-07-19T12:24:04+08:00">2024-07-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>原文地址：<a target="_blank" rel="noopener" href="https://kyju.org/blog/rustconf-2018-keynote/">https://kyju.org/blog/rustconf-2018-keynote/</a></p>
<p>这篇文章是关于 RustConf 2018 大会上的闭幕主题演讲的内容。以下是文章的主要内容翻译：</p>
<hr>
<p>我承诺在 RustConf 2018 的闭幕主题演讲中做两件事：</p>
<ol>
<li>我会将演讲的幻灯片放到网上。</li>
<li>我会在我的博客上发布演讲的长篇版本。</li>
</ol>
<p>​	2.a. 我实际上会为此目的创建一个博客。</p>
<p>……我花了该死的时间来做这件事。终于，我做到了我承诺会做的事情！</p>
<p>如果你还没有看到并且想看，你可以在这里看到我做的现场演讲。</p>
<p>演讲的幻灯片（有少量勘误）现在已经托管在这里。</p>
<p>所以，我在演讲中说我会发布一个可能更有趣的长篇版本，包括我无法在大约30分钟的时间槽中放入的内容。下面我包含的是我演讲的原始长篇版本，但我最初的意图并不是像这样发布。最初我想再整理一下，使其不那么像一堵文字墙，但当我开始做这件事时，我意识到我只是在完全重写它，以那种速度我永远不会发布它，而我 <em>承诺</em> 我会及时发布。</p>
<p>我对此并不满意，回想起来，我认为我为大约30分钟的演讲剪掉的很多东西可能是明智的剪掉的。我认为关于控制台开发的部分非常投机，并没有什么帮助，而最后关于语言边界特别困难的部分，虽然是真的，但有点离题。然而，人们似乎非常感兴趣，并且（非常正确地）提醒我我还没有发布这个，所以与其进一步拖延，我会给你我制作的非常轻微编辑的演讲文本版本。请记住，这是在我意识到我永远不会在30分钟内适应之前 :)。这是用非常非正式、对话的风格写的，因为这是为我演讲的素材。</p>
<p>不再赘述了……</p>
<hr>
<h2 id="RustConf-2018-演讲的草稿"><a href="#RustConf-2018-演讲的草稿" class="headerlink" title="RustConf 2018 演讲的草稿"></a>RustConf 2018 演讲的草稿</h2><p>这是我在 RustConf 2018 主题演讲中想要谈论的内容的非常粗略的大纲。</p>
<p>这次演讲假设你除了一些 Rust 的知识外，还知道一些 C++，并且有很多 C++ 代码示例，但我希望它们足够明显，不会分散那些可能不习惯 C++ 的人的注意力。</p>
<h2 id="演讲的基本论点："><a href="#演讲的基本论点：" class="headerlink" title="演讲的基本论点："></a>演讲的基本论点：</h2><p>Rust 通过设计，使某些编程模式比其他模式更痛苦。这是一件好事！事实证明，对于游戏开发来说，在 Rust 中最容易处理的模式与在 <em>任何</em> 语言中最容易处理的游戏开发模式非常相似。</p>
<p>不幸的是，我不得不以艰难的方式学到这一点！</p>
<p>Rust 极大地奖励了数据导向设计，具有简单、易于理解的所有权语义，这对于游戏开发来说是个好消息。我怀疑这通常也是正确的，不仅仅是对游戏开发！（但我能知道什么？）</p>
<h2 id="你为什么要听我说，我是谁？"><a href="#你为什么要听我说，我是谁？" class="headerlink" title="你为什么要听我说，我是谁？"></a>你为什么要听我说，我是谁？</h2><p>我是 Starbound 的首席程序员，我是 Chucklefish 最初的成员之一，当时我们都是通过 IRC 工作。当 Chucklefish 决定我们应该有一个人被称为“技术领导”时，我是技术领导。我仍然与 Chucklefish 有外围合作，但自从我回到美国后，我现在更独立地工作了。</p>
<p>但是，老实说，我不确定你 <em>应该</em> 听我说！我帮助发布了一个（1）完整的商业游戏，这次演讲的一些部分是基于我帮助制作的一个商业游戏的警示故事，关于什么 <em>不</em> 该做。</p>
<p>我绝对觉得你不应该根据我的建议做出任何……真正的 <em>成熟</em> 商业决策。我不能确定 Rust 是否适合你，或者你是否应该或不应该用 Rust 制作你的游戏，当然，可能还有更大的问题，这取决于你是独立开发者，你的个人技能水平和容忍度以及偏好，以及如果你是一家公司，你需要什么工具和引擎，中间件等。</p>
<p>我所能说的是，我个人将在未来可预见的时间内使用 Rust 进行游戏开发（和其他事情！），如果你想知道为什么，或者如果你已经决定你想使用 Rust 并想知道你将要面对什么，那么这次演讲可能很有用。</p>
<p>这次演讲将比我更喜欢的更……模糊。我通常更习惯于给出具体的非常技术性的建议，在那里我可以从第一原理几乎证明我的观点，但像架构建议或一般建议这样的事情可能永远不会那么明确。我确实认为这仍然是 _有用的_，这就是我为什么要做这件事（并且人们似乎感兴趣），但请记住：这都是我个人的看法，伙计。</p>
<h2 id="你-怎么-甚至用-Rust-制作游戏？"><a href="#你-怎么-甚至用-Rust-制作游戏？" class="headerlink" title="你 怎么 甚至用 Rust 制作游戏？"></a>你 <em>怎么</em> 甚至用 Rust 制作游戏？</h2><p>过去一年左右，我收到了很多问题，基本上在问：</p>
<blockquote>
<p>如何从零开始用 Rust 制作游戏？不，说真的……怎么做。我的意思是，我<br>可以看到你 <em>理论上</em> 怎么做，但不知何故当我尝试应用<br>我习惯的其他语言的模式时，我只是遇到很多问题？<br>我听说这被称为“与借用检查器战斗”，但……这似乎并没有真正 <em>帮助</em> 我。我做错了什么？</p>
</blockquote>
<p>或者，也许是像这样的：</p>
<blockquote>
<p>我可以看到如果你喜欢非常严格的控制，Rust 是很棒的，我可以看到它<br>被用于小型实用程序或安全性至关重要的地方，但它<br>看起来非常限制性！我真的看不出你如何在不到处遇到这些限制的情况下制作像游戏这样大的东西。你如何在不需要 Rc<RefCell> 和 Arc<Mutex> 的情况下构建像游戏这样的东西？</p>
</blockquote>
<p>这些问题（稻草人）当然是关于游戏的，但它们也反映了我见过的关于 Rust 的普遍情绪。如果不是很明显，我不同意这种情绪（毕竟我在 RustConf），我认为对我来说最好的方式是谈论为什么我不同意它，是通过谈论我所知道的，所以我将从游戏的角度来谈论这个问题。</p>
<p>这次演讲可以只是我走上讲台说“天啊，没那么难！数据导向设计！如果你在制作游戏，使用 ECS！……谢谢。”然后走下舞台，从某种角度来看，我确实觉得 <em>可以</em> 这么简单，但我认为这里有一个更重要的根本点，这就是这次演讲的内容。这个问题的非常非常简短的答案是：如果你忘记面向对象设计，而是只专注于你的游戏状态（或你正在制作的任何东西）的数据表示，并且你努力不使事情比它真正需要的更复杂，事情实际上可以相当简单！这次演讲将缓慢地向一个简单的 Rust 中的 ECS 实现工作，并尝试为每一步提供理由，但不是 <em>所有</em> 步骤都是必要的。我甚至不认为使用某种特定的设计模式如 ECS 是必不可少的，我认为更重要的更大的点是放下一些习惯，至少 <em>我</em> 有这些习惯，使事情比它们需要的更困难，尤其是在 Rust 中。</p>
<p>对一些人来说，我在这次演讲中所说的可能 _显而易见_。如果这对你来说都是显而易见的，那很好，但这些对我来说并不总是显而易见的。事实上，我之所以如此喜欢 Rust 的部分原因是，我并不是通过尝试用 Rust 构建游戏学到这些教训的，我大部分是在第一次尝试 Rust 之前，从我早期在 Starbound 中犯的错误中学到的。我需要有人来指责以展示什么 <em>不</em> 应该做，所以非常方便的是，我有一个如此好的例子在我的过去。</p>
<p>我肯定会重复其他人已经给出的一些建议。事实上，其中一些已经变得众所周知，几乎已经成为陈词滥调：继承是坏的，面向对象大多是坏的，ECS 设计是好的，等等。希望在这些 <em>是</em> 真的程度上，我提供了更多的证据，并描述了为什么这些在借用检查器的存在下尤其重要，但希望我也能给这些增加一些细微差别，这对其他想要用 Rust 进行游戏开发的人也会有所帮助。</p>
<h2 id="你怎么甚至制作游戏"><a href="#你怎么甚至制作游戏" class="headerlink" title="你怎么甚至制作游戏"></a>你怎么甚至制作游戏</h2><p>当然，这些问题只会在你尝试从头开始设计游戏架构时出现，当然，许多人实际上不会这样做。事实上，通常给独立开发者的建议是 <em>永远</em> 不要制作你自己的引擎，如果你使用像 Unity 或 Unreal 这样的引擎来制作你的游戏，很多这些决定将为你做出。</p>
<p>我绝对 <em>没有</em> 遵循这个建议。事实上，我认为 Starbound 直接违反了你通常给新独立开发者的每一条建议：</p>
<ul>
<li><p>不要制作你自己的引擎<br>(Starbound 基本上是在 SDL &#x2F; libogg &#x2F; libvorbis &#x2F; libfreetype 等之上用裸 C++ 编写的)</p>
</li>
<li><p>总是制作一个原型，并计划扔掉它<br>(我用来演示两周的代码与 1.0 版本是同一血统)</p>
</li>
<li><p>说真的，不要制作你自己的引擎，只使用 Unity &#x2F; Unreal &#x2F; Godot 等<br>(我们甚至没有使用 boost！事实上，在某个时候我们添加了我们自己的 c++17 类的版本，比如 std::optional 和 std::variant，因为当时比开始依赖 boost 更容易。我们还自己想出了一种系统来做 2D 纹理图集，因为我们找不到一种好的方法来做如此多小纹理的离线纹理图集，这些小纹理不容易分组)</p>
</li>
<li><p>你的第一款游戏应该是简单的，你应该制作一些简单的东西，你可以在短时间内发布。<br>(在 Starbound 中，你可以有一个玩家持有的物品，运行它自己的 Lua 脚本，这会影响玩家的物理属性，可以与其他物品和玩家拥有的能力合作，这些能力也有自己的脚本，也可以影响玩家的物理属性（同时），同时给玩家脚本化的状态效果，这些效果可以向大多数实体都有的通用状态数据库添加他们自己的自定义统计数据，这些统计数据也可以从脚本中控制。还有一个完整的糟糕的 DSL，用于绘制材料块，这些块在视觉上以任意复杂的方式连接在一起)</p>
</li>
</ul>
<p>我绝对不是想告诉任何人制作 <em>任何</em> 类似我制作的第一款商业游戏的东西，不要跟随我的脚步，我不认为我会推荐给任何人。然而，实际上有很多独立开发者不使用 Unreal &#x2F; Unity 风格的游戏引擎，而是使用更多的“库”风格的游戏引擎，他们只使用单个库来提供特定功能，或者使用主要提供渲染，音频和输入的小“框架”，并自己创建他们制作的游戏的基本结构。（我曾经有一个移植公司称这种“旧学校”开发风格，这让我非常沮丧）</p>
<ul>
<li><p>任何使用 XNA 或 MonoGame 制作的游戏。XNA &#x2F; MonoGame 肯定在单个包中提供了很多（渲染、声音、输入），但它们不决定游戏本身的架构。这包括 Terraria 和 Stardew Valley，只是举两个例子。</p>
</li>
<li><p>任何由 Jonathan Blow 制作的游戏（Braid, The Witness）</p>
</li>
<li><p>任何由 Zach Barth 制作的游戏（Zachtronics）。他曾表示，当他开始开发游戏时，他从一个裸事件循环（输入 &#x2F; 更新 &#x2F; 渲染）开始。（注意：我找不到这个的来源，所以我希望我没有误解他，我认为他在我现在找不到的采访中说过）</p>
</li>
<li><p>任何由 Supergiant 制作的游戏（Bastion, Transistor, Pyre）</p>
</li>
<li><p>完全在内部制作的 Chucklefish 游戏：显然 Starbound，还有 Wargroove（使用通用 C++ 引擎 halley 制作，但引擎的主要开发人员是 Wargroove 的主要开发人员）。</p>
</li>
<li><p>还有很多很多我没有列出的，许多 2D 游戏是这样制作的，一些 3D 游戏也是如此。有 <em>几十个</em> 我们，我告诉你。</p>
</li>
</ul>
<p>显然，如果我的建议不适用，你决定使用像 Unity 或 Unreal 这样决定了大部分游戏结构的有偏见的游戏引擎，那么我并不是试图说服你离开。显然，如果你使用其中之一，并且你很高兴，那么我不会试图说服你离开。显然，如果你使用其中之一，Rust 可能就不可能了，除了非常非常外围的事情，但老实说，我仍然认为最终 Rust 会找到进入这些商业主流游戏引擎产品的方式，只是时间问题。</p>
<p>不过，目前，最有可能使用 Rust 并发现这次演讲有用的人是其他从头开始的独立类型，以及一些在内部制作大量技术的 AAA 工作室（Ready at Dawn!, EA SEED!）。我也相信，迟早会有使用 Rust 的 Unity 或 UE 竞争对手！</p>
<p>那么好吧，假设你决定制作一款游戏，你 <em>不打算</em> 使用像 Unreal 或 Unity 这样决定大部分游戏结构的有偏见的游戏引擎，你决定使用 Rust，那么这样的东西会是什么样子？</p>
<h2 id="过去是如何制作游戏的"><a href="#过去是如何制作游戏的" class="headerlink" title="过去是如何制作游戏的"></a>过去是如何制作游戏的</h2><p>所以，在过去，游戏主要是以“数据导向”的方式工程化的，这纯粹是出于必要。当你的目标控制台有 128KB 的 RAM（SNES）时，就没有多少抽象的余地。我将把这个时代称为视频游戏开发的“行动回放”时代。如果你不知道，这些是作弊设备，有点像“游戏精灵”或“游戏鲨鱼”，如果你知道的话，你可以在每一帧修补游戏的 RAM 状态。“游戏精灵”和类似的设备允许你修补游戏卡带的 ROM，但“行动回放”设备实际上让你插入钩子到比如说，VBlank 处理程序，覆盖每一帧的实际内存值，以比如说给你无限生命等。</p>
<p>这之所以有效，是因为显然在 128KB 的 RAM 中，你不太可能有 malloc 的实现！。每一字节的存储都是非常宝贵的，所以大多数这个时代的游戏都是设计得非常可预测的手动管理它们整个游戏状态在内存中。在 NES &#x2F; SNES 时代，内存如此之少，通常图形表示你的游戏（瓦片，精灵）和你的逻辑表示你的游戏是相同的，如果你眯着眼睛看，你会看到“实体”结构，但通常游戏可以跟踪的“事物”的最大数量是如此之少，以至于没有足够的空间用于任何通用性。这有时也被称为游戏开发的“场外治愈力”时代，因为一旦你离开屏幕，游戏关卡的那部分通常就被遗忘了（敌人神奇地被治愈了）。</p>
<p>想象一下，如果你要为 NES 编写一个 Rust 游戏（可能真的很难，但不是不可能？至少不比 C 难，C 同样真的很难。我相当确定基本上所有 SNES 时代的游戏都是用汇编语言编写的。），你可能会定义一个单一的静态数据结构，像这个完全虚构的例子：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">ProjectileType</span> = <span class="type">u8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">EnemyType</span> = <span class="type">u8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">EnemyBehavior</span> = <span class="type">u8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">Tile</span> = <span class="type">u8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PlayerProjectile</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> pos: Vector2&lt;<span class="type">i16</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> proj_type: ProjectileType,</span><br><span class="line">    <span class="comment">// 等等...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Enemy</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> pos: Vector2&lt;<span class="type">i16</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> enemy_type: EnemyType,</span><br><span class="line">    <span class="keyword">pub</span> behavior: EnemyBehavior,</span><br><span class="line">    <span class="comment">// 等等...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> player_pos: Vector2&lt;<span class="type">i16</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> player_vel: Vector2&lt;<span class="type">i8</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> player_health: <span class="type">i8</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 你想要屏幕上超过 4 个炮弹？不行，如果玩家发射更多，清除最旧的以腾出空间，或者等到它们击中</span></span><br><span class="line">    <span class="comment">// 某些东西或移出屏幕（像洛克人一样）。</span></span><br><span class="line">    <span class="keyword">pub</span> player_projectiles: [<span class="type">Option</span>&lt;PlayerProjectile&gt;; <span class="number">4</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有关卡数据都存储在这个常量内存块中。</span></span><br><span class="line">    <span class="keyword">pub</span> level_tiles: [[Tile; <span class="number">64</span>]; <span class="number">64</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 屏幕上有 8 个敌人，之后，你必须等待敌人消失才能生成更多（在 Kirby&#x27;s Adventure 中，这在工具辅助速通中被高度滥用）</span></span><br><span class="line">    <span class="keyword">pub</span> enemies: [Enemy; <span class="number">8</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等等...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以通过这种方式了解软件的工作原理，即使你这是一个虚构的例子。</p>
<p>这里需要注意的一件事是，由于每个 SNES 游戏很可能是用汇编语言编写的，几乎可以肯定没有“数据隐藏”这样的事情，游戏的整个状态在任何时候都可以被更新循环访问。</p>
<p>这种每个内存位置都很宝贵，对象被仔细地放置在其中的时代实际上持续了很长时间，至少一直到 N64。</p>
<p>让我们看另一个我比较熟悉的例子，它仍然牢固地处于这个时代，但其设计在我看来更接近现代游戏引擎。我最喜欢的游戏之一：Mario 64。Mario 64 很有趣，因为它是 3D 的，除了低多边形简单图形外，它真的 <em>那么</em> 不同于现代 3D 平台游戏吗？然而，它仍然牢固地处于“行动回放”时代的游戏，当你进入一个“游戏世界”（你可以像马里奥一样奔跑和跳跃）时，你可以可靠地告诉（或多或少）所有的关卡数据将生活在 N64 的广阔，豪华的 4 个 MB 的 ram 中。有一个可预测的内存块用于关卡几何，用于许多不同的关卡标志等，但游戏中的大部分动态内容都以通用的“实体”（或“对象”）的形式存在，就像现代游戏引擎一样。在 Mario 64 中，实体结构都是完全 608 字节长，并且有一个硬限制为 240 个（有时这有点少，比如在 Bowser in the Fire Sea 中，限制为 232 个对象）。</p>
<p>我们实际上不知道 Mario 64 是用什么语言编写的，但它 <em>可能</em> 是 C，所以这可能是一个时代，如果你有一台时间机器和一个强烈的愿望想要一个更好的系统语言来自未来，你可以很容易地使用 Rust 制作商业 Nintendo 64 游戏。让我们采取很多艺术自由，并想象这样一个游戏的结构，尽可能直接地翻译成 Rust：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EntityAnimation</span> = <span class="type">u8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EntityBehavior</span> = <span class="type">u8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    <span class="comment">// 这个实体是否初始化并且活跃，或者它是否死亡并且可以被覆盖。</span></span><br><span class="line">    <span class="keyword">pub</span> initialized: <span class="type">bool</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 好吧，这真的很有趣。在 Mario 64 中，所有实体被划分为“重要”和“不重要”的实体。重要的实体是</span></span><br><span class="line">    <span class="comment">// 像马里奥自己，硬币，敌人等。不重要的实体是像风效果或从马里奥的屁股踩出来的星星</span></span><br><span class="line">    <span class="comment">// 这样的效果。当游戏用完实体插槽时，它将删除不重要的实体以为重要的实体腾出空间。如果游戏</span></span><br><span class="line">    <span class="comment">// 试图创建超过 240 个重要的实体（或在 BitFS 中为 232），它将挂起。</span></span><br><span class="line">    <span class="keyword">pub</span> important: <span class="type">bool</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> position: Vector3&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> rotation: Vector3&lt;<span class="type">f32</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我认为在真正的 Mario 64 中，大多数这样的事情是指针，但它们也可以很容易地是索引。这</span></span><br><span class="line">    <span class="comment">// 被证明是相当重要的。</span></span><br><span class="line">    <span class="keyword">pub</span> animation: EntityAnimation,</span><br><span class="line">    <span class="keyword">pub</span> behavior: EntityBehavior,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> visible: <span class="type">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> damage_mario_on_touch: <span class="type">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> home_in_on_mario: <span class="type">bool</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用计时器，用于许多动画和游戏目的</span></span><br><span class="line">    <span class="keyword">pub</span> timer: <span class="type">u16</span>,</span><br><span class="line">    <span class="comment">// 通用动作，对不同的实体类型有不同的用途</span></span><br><span class="line">    <span class="keyword">pub</span> action: <span class="type">u8</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更多的东西...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">EntityIndex</span> = <span class="type">u8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">WorldRenderGeometry</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">WorldCollisions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> world_render_geometry: WorldRenderGeometry,</span><br><span class="line">    <span class="keyword">pub</span> world_collisions: WorldCollisions,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 真的，不超过 240</span></span><br><span class="line">    <span class="keyword">pub</span> entities: [Entity; <span class="number">240</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 而不是指针，我们存储一个索引到实体数组中。</span></span><br><span class="line">    <span class="keyword">pub</span> mario_entity: EntityIndex,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更多的东西...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，这些表示的具体细节并不是真的很重要，重要的是：</p>
<ul>
<li><p>游戏状态的表示（尽管这里被极大地简化了）在真正的游戏中仍然非常 _简单_。它非常可预测，并且易于 RAM 值戳，这里并没有真正的“抽象”，一切都是相当字面和</p>
</li>
<li><p>专门建造的。</p>
<ul>
<li><p>我们不能确定 N64 时代所有游戏使用的语言，但我们知道至少有一些标题肯定是 C（Shadows of the Empire），并且很可能在大多数情况下是 C。游戏结构都倾向于像 Mario 64 那样简单和可预测，你可以想象游戏状态主要被表示为全局 C 结构或结构数组。</p>
</li>
<li><p>我在这里猜测，但 <em>可能</em> 没有太多的“数据隐藏”，你可以想象这些游戏的结构更像是一个巨大的静态全局结构，包含“所有游戏状态”，对游戏的所有代码都是可见的。</p>
</li>
<li><p>偶尔有指向函数的指针，但似乎没有太多的面向对象的东西。似乎没有 vtables，甚至没有多少像 vtables 这样的东西，或者类似的东西。这可能是纯粹的猜测，并且肯定只是非专家的意见，但从我对 SNES - N64 时代标题的内存布局和设计的“广泛”研究来看，通常感觉你可以从数据格式中想象出构成引擎的基本、无聊、专门制作的 C 代码。</p>
</li>
</ul>
<p>好的，想象一下你将以与最初设计非常相似的方式编写 Mario 64，但是在 Rust 中。你将有效地编写一个巨大的、程序化的、单一用途的游戏引擎，在一个更漂亮的 C 中，但在其核心，仍然像 C。有效地你的游戏引擎是类似于（即将到来的戏剧性过度简化）：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EntityAnimation</span> = <span class="type">u8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EntityBehavior</span> = <span class="type">u8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    <span class="comment">// ... 见上文</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">EntityIndex</span> = <span class="type">u8</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">WorldRenderGeometry</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">WorldCollisions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    <span class="comment">// ... 见上文</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 所有的游戏状态，道德上是一个全局变量。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">game_state</span> = GameState &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="comment">// 每一次这个循环都是 1 帧，对于一个 60fps 的游戏来说是 16ms。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 我们一次捕获整个输入，在一帧的开始。甚至真的不需要像输入事件这样复杂的东西，因为在</span></span><br><span class="line">        <span class="comment">// 像 Mario 64 这样的东西中，真正发生的读取控制器状态就是读取控制器状态的特定内存区域。在这里，</span></span><br><span class="line">        <span class="comment">// 我们只是在帧的开始这样做，在真正的 Mario 64 中我相信每一帧都会在不同的系统中分布。</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">input_state</span> = <span class="title function_ invoke__">capture_input_state</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 让我们有一系列函数根据上一个游戏状态和输入改变游戏状态</span></span><br><span class="line">        <span class="comment">// 我们将这种非常简单的模式命名为一个“系统”。</span></span><br><span class="line">        <span class="comment">// 设置马里奥内部的状态标志以开始跳跃，或者也许设置一个标志来表示你是否暂停。</span></span><br><span class="line">        <span class="title function_ invoke__">input_system</span>(&amp;<span class="keyword">mut</span> game_state, &amp;input_state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pos += vel * dt; 应用重力。对所有实体进行碰撞检测和响应</span></span><br><span class="line">        <span class="title function_ invoke__">physics_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为每个实体运行实体逻辑，这可能会分派到 update_mario, update_baddies, update_platforms 等。</span></span><br><span class="line">        <span class="title function_ invoke__">entity_logic_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... 更多的系统</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 渲染当前的游戏状态。在 N64 时代，这在某些方面比现在简单得多，但即使在那时也可能仍然相当混乱和有状态的，所以也许我们的游戏状态包括加载的图形资源的状态。</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">render_system</span>(&amp;<span class="keyword">mut</span> game);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取实体的状态标志并触发新的音频，这和渲染一样混乱和有状态的。</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">audio_system</span>(&amp;<span class="keyword">mut</span> game);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待 VBlank</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">wait_vblank</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重复。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我不是推荐你以这种方式制作游戏！然而，即使你认为这 100% 是一个荒谬的过度简化，或者你认为即使你可以以这种方式制作一个大型复杂的游戏，它也会变成一个程序化的泥球，让我们来看一下这个一段时间，看看是否有任何优势，然后再完全否定它。显然有一个巨大的、明显的劣势，那就是整个游戏状态对所有系统都是可见和可变的，如果某些东西意外地改变了，你可能不知道去哪里查找以找出是什么在不当的方式改变游戏状态。没有人 <em>真的</em> 建议在现代时代编写软件，将所有状态作为实际上的全局变量。</p>
<p>然而，这里有一个优势，那就是通过一点点关心，你可以以 100% 安全的 Rust 编写游戏，几乎肯定不会遇到借用检查器的问题。你可能无法安全地使用 _指针_，因为 <em>肯定</em> 如果你使用指针，你的整个游戏状态将有内部指针指向自身，所以我们需要对 Mario 64 风格进行一个修改，那就是在所有会有指针的地方，改为存储到某个数组的索引。这个的经典例子是我们 GameState 中的“mario_entity”字段。这可能看起来过于限制性，但经过一些思考，它变得清晰，特别是如果你有常量限制（你甚至没有 malloc，记住！），你总是可以添加像 <code>all_the_textures: [TextureDescriptor; 256]</code> 这样的内容，并使用这个静态数组的整数索引来描述纹理，而不是像指针这样的东西。另一个原因是这在借用检查器方面是有帮助的，因为 Rust 非常擅长让你为不同的字段分割借用，所以既然我们假设的引擎中的一切都是一个巨大的嵌套公共结构体，你应该总是能够读取游戏状态并改变每个系统所需的确切部分。记住，大多数“行动回放”时代的游戏都是这样编写的，通常没有任何 malloc-ing，最多有一些非常有限的东西像“分配”只从一个固定数组中，而且大多数东西都或多或少地仔细地放置在某个静态结构中。</p>
<p>这种风格的另一个批评是，你可能会说使用索引而不是指针在严格意义上是“安全”的，但可能只是技术上的，你正在用指针的 UB 和潜在崩溃来换取“随机但未指定”的行为，如果你访问了错误的或过时的索引，可能会引发 panic。你说得对，顺便说一下！我们将稍后再讨论这个问题，但只是现在接受这是可能的和安全的，这种设计并没有直接反对借用检查器。</p>
<p>好的，现在我已经描述了一个你 <em>可能</em> 会用 Rust 编写游戏的方式，这种方式在道德上与最古老的游戏架构非常接近。我并不是在为你的下一款游戏或其他什么而提倡这个，但确实有一些现在编写的游戏比这更少，以直接的、单一用途的程序化风格编写。我不会叫出具体的游戏，但我见过很多以这种方式编写的游戏，通常包裹在一层薄薄的面向对象的外表中。我见过游戏源代码有一个单一的 <strong>12k</strong> 行世界生成函数。这不是对这种游戏的侮辱，甚至边际上也不是，做这些事情的人通常是绝对的天才，他们只是非常擅长知道关心什么和不关心什么。这里确实有真正的智慧！</p>
<p>但我仍然不是在提倡这个。让我们将这称为“UR-game-architecture”，我们将回到这一点。这是从底层接近“数据驱动！使用 ECS！”的答案，让我们现在从顶层接近这个。</p>
<h2 id="太多的面向对象"><a href="#太多的面向对象" class="headerlink" title="太多的面向对象"></a>太多的面向对象</h2><p>现在我们已经涵盖了可能最简单的混乱的过程化 C 风格的游戏引擎设计，让我们尝试应用面向对象设计的原则，看看这是否是一种改进。我将以 Starbound 或 Starbound 的某种简化为例，因为我有幸对它了解很多，并且手头有它的源代码，所以我在描述它时不会 <em>太</em> 多地撒谎。</p>
<p>面向对象的原则是什么？并不是每个人都完全同意面向对象是什么，但我会包括一些基本的、希望没有争议的要点：</p>
<ul>
<li>单一职责原则 - 对象应该有一个单一的逻辑集的职责，方法应该在这些职责集中执行一个操作。</li>
<li>封装 - 你应该将数据与操作它的函数绑定在一起，使它们免受外部干扰和误用。这允许你通过改变类的内部表示而不改变其行为来进行重构。</li>
<li>抽象，或“里斯科夫替代原则”，或类似的 - 你应该能够用一个派生类替换另一个，只要它们共享相同的基类并通过该基类（或接口，或其他什么）使用。</li>
<li>接口隔离，或最少耦合原则等 - 一个类对另一个类的依赖应该使用尽可能小的接口。</li>
</ul>
<p>在实际层面上，面向对象语言通常有一些重要的特性来支持面向对象设计，即对象方法、私有对象数据、继承、虚拟方法等。我主要会谈论 C++，因为它有很多面向对象的陷阱，它是我所知道的，并且它是超级流行的语言，用于“我要制作我自己的引擎”的游戏开发人群。</p>
<p>我们将尝试这些原则，并看看它们如何被误用于游戏开发，然后讨论即使它们经常失败于游戏开发（这现在是一个“众所周知”的状态），它们在 Rust 中失败得 <em>更</em> 壮观。用这些原则 <em>是</em> 可能制作游戏的，而且它们并不是 <em>全部</em> 都是普遍糟糕的想法。我并不是面向对象的 _支持者_，但至少有一些好的想法是与面向对象相关或从面向对象中产生的（所有这些 Rust 都有，并且可以很好地执行）。</p>
<ul>
<li><p>点运算符或“后缀函数”。如果你是 Haskeller，这是“类型导向名称解析”，而不是通常的情况，即“名称导向类型解析”。一种“强大”的方式，避免必须用非常短的公共名称来限定 100 个不同的函数，或者为所有事情都有 C 风格的前缀。对 IDE 也很棒！</p>
</li>
<li><p>具有法律（合同）的接口 - Rust traits！没有继承在望，它们最好时是小的，并且围绕它们有有意义的规则，但如果你看它们，它们有点像 C++ 纯虚类。它们 _很棒_，就像 Haskell 类型类很棒一样。 </p>
</li>
<li><p>数据隐藏 - 能够隐藏数据以维护不变性是非常宝贵的，没有它，就不可能安全地将接口暴露给不安全的</p>
</li>
<li><p>代码。在小范围内非常有用，以及与“库”代码一起使用。</p>
<p>所以只是为了记录，我不是在挑剔上面的好部分，这些是好的，甚至很棒。有了这个，让我们看看面向对象设计的其他部分如何失败于游戏开发。</p>
<p>所以，表面上游戏似乎很适合面向对象，因为当你试图想出面向对象的设计时，有一些明显的“对象”会跳出来。以 Starbound 为例，像“玩家”，“NPC”，“怪物”这样的事物是很容易理解的概念，是我们游戏中对象的明显候选者，让我们从这些开始。我们还将包括一个“世界”类，像 Mario 64 示例一样，是一些现场游戏场所的基本结构（我们故意跳过像接口、菜单等事情，专注于游戏引擎的核心部分）。我还将不得不切换到 C++，因为其中一些将很难用 Rust 表达。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> EntityId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">HumanoidAnimationState</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HumanoidItem</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    Vec2F position;</span><br><span class="line">    Vec2F velocity;</span><br><span class="line">    <span class="type">float</span> mass;</span><br><span class="line"></span><br><span class="line">    HumanoidAnimationState animation_state;</span><br><span class="line"></span><br><span class="line">    HumanoidItem left_hand_item;</span><br><span class="line">    HumanoidItem right_hand_item;</span><br><span class="line"></span><br><span class="line">    Vec2F aim_position;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> health;</span><br><span class="line">    EntityId focused_entity;</span><br><span class="line">    <span class="type">float</span> food_level;</span><br><span class="line">    <span class="type">bool</span> admin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 还有很多...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">MonsterAnimationState</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DamageRegion</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Monster</span> &#123;</span><br><span class="line">    Vec2F position;</span><br><span class="line">    Vec2F velocity;</span><br><span class="line">    <span class="type">float</span> mass;</span><br><span class="line"></span><br><span class="line">    MonsterAnimationState animation_state;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> health;</span><br><span class="line">    EntityId current_target;</span><br><span class="line">    DamageRegion damage_region;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Npc</span> &#123;</span><br><span class="line">    Vec2F position;</span><br><span class="line">    Vec2F velocity;</span><br><span class="line">    <span class="type">float</span> mass;</span><br><span class="line"></span><br><span class="line">    HumanoidAnimationState animation_state;</span><br><span class="line"></span><br><span class="line">    HumanoidItem left_hand_item;</span><br><span class="line">    HumanoidItem right_hand_item;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> health;</span><br><span class="line">    Vec2F aim_position;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">WorldTile</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    List&lt;EntityId&gt; player_ids;</span><br><span class="line">    <span class="comment">// 嗯，我们可能需要一个接口和向下转型？</span></span><br><span class="line">    HashMap&lt;EntityId, <span class="type">void</span>*&gt; entities;</span><br><span class="line"></span><br><span class="line">    MultiArray2D&lt;WorldTile&gt; tiles;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>马上，我们看到了数据类型中的重复结构，可能这些应该是有自己的方法的子对象，让我们稍微勾画一下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> EntityId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">HumanoidAnimationState</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HumanoidItem</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Physics</span> &#123;</span><br><span class="line">    Vec2F position;</span><br><span class="line">    Vec2F velocity;</span><br><span class="line">    <span class="type">float</span> mass;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidState</span> &#123;</span><br><span class="line">    HumanoidAnimationState animation_state;</span><br><span class="line">    HumanoidItem left_hand_item;</span><br><span class="line">    HumanoidItem right_hand_item;</span><br><span class="line">    Vec2F aim_position;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    Physics physics;</span><br><span class="line">    HumanoidState humanoid;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> health;</span><br><span class="line">    EntityId focused_entity;</span><br><span class="line">    <span class="type">float</span> food_level;</span><br><span class="line">    <span class="type">bool</span> admin;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">MonsterAnimationState</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DamageRegion</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Monster</span> &#123;</span><br><span class="line">    Physics physics;</span><br><span class="line"></span><br><span class="line">    MonsterAnimationState animation_state;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> health;</span><br><span class="line">    EntityId current_target;</span><br><span class="line">    DamageRegion damage_region;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Npc</span> &#123;</span><br><span class="line">    Physics physics;</span><br><span class="line">    HumanoidState humanoid;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> health;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">WorldTile</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    List&lt;EntityId&gt; player_ids;</span><br><span class="line">    HashMap&lt;EntityId, <span class="type">void</span>*&gt; entities;</span><br><span class="line"></span><br><span class="line">    MultiArray2D&lt;WorldTile&gt; tiles;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>到目前为止，这还不错，但这仍然只是描述了我们游戏中的数据结构。记住，我们谈论的面向对象原则之一是封装，你想要为这些结构（我们应该叫它们类！）暴露最小的接口和方法，并且只暴露必要的内容。另外，world 内部的 entities 中有一个 void 指针，我们可能不应该有这个，我们需要以某种方式存储我们的实体，让我们在这个时候制作一个 Entity 接口，同时我们也是在制作它的时候为所有实体的共同事物制作一个 Entity 接口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> EntityId;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预先声明 World 以将其传递给 Entity</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">World</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">InputState</span> &#123; ... &#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RenderState</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 纯虚接口！</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 好吧，*肯定* 所有实体都会有一个位置，这可能是 const 的。</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有实体都有速度吗？实际上可能不是，可能还有一些静态实体，所以我们跳过速度。还有</span></span><br><span class="line">    <span class="comment">// 其他共同的字段吗？老实说，可能有一些值得放在这里，但如果没有立即想到的案例，可能</span></span><br><span class="line">    <span class="comment">// 不会有*太多*，也许它们都会返回 Maybe 或者其他什么，但这听起来作为一个接口并不是很有用？我们将</span></span><br><span class="line">    <span class="comment">// 只是为这些制作更多的接口，坚持面向对象设计！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 好吧，我们肯定必须更新每个实体，可能还要渲染它，所以让我们为此定义一些方法。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 好吧，我们肯定必须将实体的世界传递给它的更新方法，因为例如玩家必须能够做</span></span><br><span class="line">    <span class="comment">// 像生成投射物实体这样的事情，怪物和 NPC 可能也是如此。另外，怪物必须知道玩家在哪里才能攻击他们！</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让我们假设这些不是太状态化的和混乱的，每个实体都可以以某种合理的方式“自己渲染自己”。</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 没有私有数据！我们肯定知道我们应该优先考虑组合而不是继承，因为我们以前听说过这个，所以只有纯</span></span><br><span class="line">    <span class="comment">// 虚拟接口给我们！这可能是面向对象设计的 *可能* 基本上已经死了的一个方面？我实际上不确定，但我知道这已经被讨论到死了，所以我们不必再打这个</span></span><br><span class="line">    <span class="comment">// 死马了。</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> : Entity &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Physics m_physics;</span><br><span class="line">    HumanoidState m_humanoid;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Monster</span> : Entity &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Physics m_physics;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NPC</span> : Entity &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Physics m_physics;</span><br><span class="line">    HumanoidState m_humanoid;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">WorldTile</span> &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    List&lt;EntityId&gt; player_ids;</span><br><span class="line">    HashMap&lt;EntityId, shared_ptr&lt;Entity&gt;&gt; entities;</span><br><span class="line"></span><br><span class="line">    MultiArray2D&lt;WorldTile&gt; tiles;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>所以在我们继续之前，为什么我在这里麻烦 <code>EntityId</code> 这些东西？这是 C++，我们不能用指针吗？好吧，事实证明这样做是非常 <em>不安全</em> 的，所以所有我见过的游戏引擎（在没有花哨垃圾收集器的语言中）都采用的是有一些形式的“实体 id”到实际实体指针的映射，并将这个映射保存在一个地方的模式。原因是，在 C++ 中，假设每个实体都保留一个 shared_ptr 或某种形式的 downcasted shared_ptr。那么问题就来了，World 现在是一个巨大的引用循环球，实体可能永远不会被销毁，这是一个巨大的问题。另一方面，如果它们保留了原始指针，它们将不断地失效，这往往会导致难以解决的短暂错误，所以几乎没有人这样做（至少，没有人保留原始指针 &#x2F; 引用很长时间）。你可以使用例如 weak_ptr，这有时被使用，但往往有其他原因使用 ids，因为它们对网络编程很有用，并且可以更容易地从磁盘保存和加载。这很有趣，因为这是我们在“UR-game-architecture”中必须做出的主要改变，以使其与 Rust 兼容，但这在游戏引擎中非常 <em>非常</em> 常见！</p>
<p>（在游戏引擎中，EntityId 通常是一个像 int 这样不断增加的东西，可能是一个不循环的 uint64_t 或者是一个循环的 uint32_t，这样做是为了让 EntityId 永远不会或很少被重新使用。这样，如果一个实体消失了，通常任何监控它的都会注意到它已经走了，而不是被其他实体立即取代。这里还有一个模式叫做“代际索引”，这很重要，我稍后会谈论）</p>
<p>好的，所以这似乎是… 真的可以制作一个复杂的游戏吗？我可以想象一个 <em>非常</em> 简单的游戏，你可以用这些类和接口制作，但让我们更详细地看看我们会碰到什么问题。</p>
<p>让我们想想一个怪物需要跟踪一个玩家。它们可能会遍历世界上所有的实体，过滤只有玩家，按距离排序（在现实中你会使用某种空间哈希 &#x2F; kd-tree），然后跟踪最近的一个。实际上这似乎基本上可能与这个一样！好的，新要求：怪物应该首先跟踪健康值最低的玩家。呃哦，好吧，玩家的健康是私有的，所以我们最好为这个做一个公共访问器：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> : Entity &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">float</span> <span class="title">health</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们 <em>可以</em> 只让健康公开，但面向对象设计！如果健康值降到某个值以下，就会触发某个动画状态怎么办？关于伤害呢？当然，单一职责原则说明一个 <em>怪物</em> 不应该负责设置一个 <em>玩家</em> 的健康。</p>
<p>好的，新要求：怪物不应该去追标记为“管理员”的玩家。好的，添加一个访问器！</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> : Entity &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">float</span> <span class="title">health</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_admin</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>好的，我们制作了一个小原型游戏，但还没有伤害发生，所以让我们开始设置伤害。嗯，玩家的伤害系统应该放在哪里？可能玩家应该减少他们的健康，因为这是 <em>他们</em> 的健康……或者怪物可以这样做，因为这是 <em>他们的</em> 伤害区域？我不知道，我会说这是玩家的工作。我猜这意味着我们需要怪物的访问器来获取他们的伤害区域：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Monster</span> : Entity &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> DamageRegion&amp; <span class="title">damage_region</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这正在变成很多访问器。我们 <em>可以</em> 只开始公开更多的事情，但面向对象原则是什么？我们应该尽可能少和有限地暴露接口，这样我们就可以改变我们的实现而不需要重构。也许这不会 <em>那么</em> 糟糕。</p>
<p>好的，新要求：某些怪物只有在玩家靠近他们触摸地面时才会激怒。好的，这将需要更多的访问器，但因为我们一直在遵循关于代码重用的好的面向对象原则，我们有内部成员 m_physics 类型 <code>Physics</code>，它是唯一知道实体是否接触地面的东西。所以，我想 Physics 需要一个访问器来获取其内部状态 <code>Physics::onGround</code> 然后 <em>Player</em> 需要一个访问器 <code>Player::onGround</code> 这反过来将使用 <code>Physics::onGround</code>。好的，这正在变成 <em>很多</em> 访问器。</p>
<p>感觉就像每次有新需求进来，你都必须对可能曾经是合理的接口“再打更多的洞”。8 个月后，大部分半游戏都是这样建造的，有很多这些洞被戳穿。很多代码没有清晰的地方，因为它涉及到多个实体，很多逻辑上相似的功能被分散在几个文件中。“面向对象的问题在于一切都发生在别处”。</p>
<p>新需求来了：我有一个特殊物品的想法，当玩家拿着它靠近特定类型的敌人时，它会发光。触发这个的敌人应该害怕这个物品并后退，但有一种特殊的动画，他们被发光的物品迷住了。这只对达到某些特定任务目标的玩家有效。</p>
<p>你沮丧地举起双手，这将需要 4 个单独的模块来了解所有其他模块的内部（玩家、物品、怪物、动画）。你增加了更多的访问器和特殊接口。事情一团糟。</p>
<p>所以这些是虚构的例子，但它们与我 <em>很多</em> 经历的真实事情并没有太大的不同。这就是为什么现在普遍认为面向对象在游戏开发中 <em>大多数</em> 只是阻碍。数据隐藏在游戏之外的代码中除了在边缘保持不变性之外，几乎没有什么用处，其中事情更小，更有限。你的游戏中很多有趣的行为最终会跨越许多数据类型，并不自然地“属于”任何特定的实体。很多实体类型 80% 或 60% 与其他类型相似，很难重用代码，我们在实体中添加的模块越多，以帮助重用代码，就增加了更多的层次。与我们的 UR-架构相比，我们获得了什么？不是所有东西都对所有功能可见，即使我们不断增加更多的访问器，它也几乎是这样？也许在代码组织上稍微好一些，但有时 _更糟_？</p>
<p>好的，显然这在 C++ 中有很多缺点，并不是每个游戏都像 Starbound 那样有如此多的疯狂一次性功能。也许这只是一个极端的例子，通常这并不是那么糟糕的问题？让我们看看如果你尝试在 Rust 中这样做会发生什么！ _马上_，事情开始变得 _困难_。让我们回到 C++ 中最简单的面向对象版本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typedefs...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">input</span><span class="params">(<span class="type">const</span> InputState&amp; input_state)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(World* world)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">render</span><span class="params">(RenderState&amp; render_state)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// entity definitions...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    List&lt;EntityId&gt; player_ids;</span><br><span class="line">    HashMap&lt;EntityId, shared_ptr&lt;Entity&gt;&gt; entities;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>部分翻译成 Rust：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">position</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Vec2F;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">input</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, input_state: &amp;InputState);</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">update</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, world: &amp;<span class="keyword">mut</span> World);</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, render_state: &amp;<span class="keyword">mut</span> RenderState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    player_ids: <span class="type">Vec</span>&lt;EntityId&gt;,</span><br><span class="line">    entities: HashMap&lt;EntityId, Rc&lt;Entity&gt;&gt;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即使在这个很小的例子中，你已经可以看到这将是一个巨大的麻烦。首先，World 拥有每个 Entity，但每个 Entity 有一组可变的方法，其中之一必须接受一个 World 的可变引用。这不会起作用，因为你将可变地借用一个 Entity，然后必须再次可变地借用它以传递一个 World 引用（这可能会包含 self Entity）。为了做到这一点，可能 <em>每个</em> Entity 实现都需要内部可变性，否则它们将没有办法获取 World 引用，而且 World 可能也需要内部可变性，因为它也需要通过不可变引用传递。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">position</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Vec2F;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">input</span>(&amp;<span class="keyword">self</span>, input_state: &amp;InputState);</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">update</span>(&amp;<span class="keyword">self</span>, world: &amp;World);</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, render_state: &amp;<span class="keyword">mut</span> RenderState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    player_ids: RefCell&lt;<span class="type">Vec</span>&lt;EntityId&gt;&gt;,</span><br><span class="line">    entities: RefCell&lt;HashMap&lt;EntityId, Rc&lt;Entity&gt;&gt;&gt;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好的，现在我们在实体更新期间不会有借用错误，但现在一切都必须在 RefCell 里面？也许我们可以将我们整个状态放在一个 RefCell 里面，这样就不会太难？我们已经讨论了复杂行为非常跨领域的倾向，如果有以下情况：</p>
<p>一个怪物伤害了一个玩家，这触发了玩家播放一个音效作为受伤的音效，但出于游戏原因，这也触发了一个逻辑声音，其他生物可以对它做出反应。也许有一些特定的怪物类型会有群体行为？所以，伤害一个玩家触发了一个外部突变（音频），内部突变（健康），然后可能触发怪物，它们有自己的内部突变（目标实体）。也许这一切都是从怪物开始的，所以控制流从怪物到玩家，然后 <em>回到</em> 怪物。如果你在调试怪物，现在你已经通过间接触发你自己结构体方法中的突变触发了 <em>诡异的动作在</em> 远处。除了，Rust 不允许这样做，（这甚至可能不会在 RefCell 中类型检查），所以在 Rust 中的版本是，你简单地得到了一个 RefCell panic。</p>
<p>让我们继续，假设实体有一些标签或动态标签集，让我们将这个添加到我们的 C++ Entity 接口：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> List&lt;Tag&gt; <span class="title">tags</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>假设你分析了你的游戏，简单地返回一个 <code>List&lt;Tag&gt;</code> 的副本正在消耗大量的 CPU 时间，所以你将接口改为这样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Vec2F <span class="title">position</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> List&lt;Tag&gt;&amp; <span class="title">tags</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是假设这样的改变是可能的，不是一个等待发生的使用后释放错误，这通常是这种情况。好吧，Rust 应该能让我们免于使用后释放，如果你将这个翻译成 Rust 版本会发生什么：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">position</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Vec2F;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">tags</span>&lt;<span class="symbol">&#x27;a</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">Vec</span>&lt;Tag&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我使生命周期不省略，以使其明显，但这表明这个方法返回一个单一的 Vec 引用，它借用了 _整个实体_。那是.. 有帮助的，但如果你想要稍后调用任何可能发生变异的其他方法，那也没有帮助。如果这有内部可变性并且在 RefCell 里面，这也是不可能的，将不得不返回 <code>std::cell::Ref</code>。一切都很难，比在 C++ 中更难。你上 IRC 寻求帮助，你得到了一个好意但可能不太有帮助的答案：“你只是在与借用检查器战斗的阶段。”</p>
<p>情况可能会更糟。Entity 很稀疏，即使是 Starbound 中真正的 <code>Entity</code>，假设你将这些相同的原则应用到 <code>World</code>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">World</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">tile</span>&lt;<span class="symbol">&#x27;a</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">self</span>, index: Vector2&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> WorldTile &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 巨大的额外成员...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果你有一个足够大的 <code>World</code> 结构，即使没有像纯虚拟接口（或在 Rust 中，特征）这样的东西，你仍然会遇到问题。访问一个瓦片应该借用 <em>整个世界</em> 吗？如果世界的所有字段都是公开的，事情会更容易，这样你就可以借一部分世界，从而允许你变异其他部分，这正是你可以做的，如果世界只是一个具有普通公共成员的结构体。这变得更加重要，世界越大，数据隐藏就越不重要，你越进入“应用”级别，情况就越糟，因为你的游戏随着你不断添加功能而变得越来越复杂。我们不是在写引擎，我们只是在 Rust 中直接写一个简单的游戏，所有的数据都必须去某个地方！</p>
<p>如果你正在写像这样的方法，更明显的是你可以使一个大型复合结构的字段公开，并且分割借用会有帮助，但想象一下你没有这样设计事情。想象一下你有 <em>两种</em> 世界，一个用于服务器，一个用于客户端。这正是 Starbound 的工作方式，并且有一个大型复杂的“世界”接口在客户端和服务器之间共享。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">tile</span>&lt;<span class="symbol">&#x27;a</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">self</span>, index: Vector2&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> WorldTile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 巨大的额外特征方法...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在 <em>不可能</em> “只让字段公开”，不管“面向对象”原则或不，就像 Entity。更多的“与借用检查器战斗”。面向对象原则指导你尽可能松散地耦合，一个很常见的策略是，不是让对象直接依赖于彼此，而是通过一个纯接口相互依赖。</p>
<p>Starbound <em>充满了</em> 这些，Entity 和 World 只是其中两个。它们 <em>放大</em> 了借用问题，通过 <em>放大</em> 你被迫借用的数量！</p>
<p>我不认为我 <em>完全</em> 能在我的 30 分钟演讲中完全证明我说的一切，这只是 <em>一点点</em> 表面，但希望我至少给了你 <em>一个</em> 我来自哪里 _的想法。我知道对你们中的一些人来说，这听起来会非常主观，可能只对特定类型的软件（游戏）听起来像有用的建议。另外，对你们中的许多人来说，这可能是无聊的，你已经都知道了，但它仍然希望看到这与一个并非每个人都参与的行业的关系。</p>
<p>但是，话虽如此，这里有一些我的收获：</p>
<ul>
<li><p>对于游戏，面向对象 <em>真的</em> 没有帮助。我列出的面向对象的有用部分是好的，但当你不是在写“库”代码，而是在写游戏时，数据隐藏 <em>一般</em> 不是有用的，只是浪费了大量的努力和时间。你的游戏数据越多，它就越会因为你不断尝试而改变，这就越糟糕。</p>
</li>
<li><p>思考“对象”与数据类型在游戏设计中听起来表面上很吸引人，但实际上是 <em>积极</em> 有害的。大多数行为并不“附加”到任何数据，如果你开始这样思考，可能会很难停止。不要将你游戏的数据表示与操作它的系统混为一谈！</p>
</li>
<li><p>有时我觉得，我宁愿处理一个单一的 12k 行巨型程序，也不愿处理一个纠缠不清的对象球。</p>
</li>
<li><p>Carmack 引用：“有时，优雅的实现只是一个函数。不是一个方法。不是一个类。不是一个框架。只是一个函数。”</p>
</li>
<li><p>有时，如果你必须写很多混乱的过程状态变化，只是 <em>诚实</em> 地处理它们，用长（也许不是 12k 行）的过程是最佳策略。诚实地面对正在发生的事情的混乱，隐藏在其他函数或方法中并不会有所帮助，它只会让事情出错时更加困惑。如果可以把事情拿出来，它们是简单和纯粹的函数，那就去做吧，但把混乱的过程真相保持原样！另一个 Carmack 的事情。</p>
</li>
<li><p>我发现思考决定游戏状态的结构类型非常容易，也很有启发性。你经常可以从代码库中学习几乎所有你需要知道的东西，只是看看所有的类型定义。如果你在看 C++，如果你只看结构成员及其关系并忽略所有的代码，这通常会告诉你比看函数名称更多的东西。我花了很多时间阅读 Haskell 代码，他们有一种模式，通常在 Rust 中被模仿，他们有一个模块叫做“Types”，只有……一些库所需的所有类型。我有点喜欢这个，我认为 Rust 非常适合这种编程。</p>
</li>
</ul>
<p>我在这里有点调皮，但什么告诉你更多，这个接口：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    <span class="function">List&lt;EntityPtr&gt; <span class="title">entityQuery</span><span class="params">(RectF <span class="type">const</span>&amp; boundBox)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是这个结构定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    SpatialHash2D&lt;EntityId, <span class="type">float</span>, EntityPtr&gt; entitySpatialMap;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>显然，这里有很多信息来自类型的 _名称_，显然 <code>SpatialHash2D</code> 是它自己的结构，有自己的子类型，但如果你很好地命名你的类型，这个观点仍然成立，你看到一个明显的面包屑路径可以跟随，以理解接口可能隐藏了什么（你的空间实体查询可能会很快，你不应该期望查询会以实体数量的线性时间进行）。</p>
<p>我问过我们是否可以使用面向对象来改进我们的 UR-架构，令人惊讶的是，我们 _基本上不能_。除了像点运算符和数据隐藏这样有用的东西之外，这些在库代码中很有用，游戏的大规模结构并没有真正得到面向对象的帮助。我们需要一种方法来处理没有制造面向对象混乱的单个巨大可变公共嵌套结构的负面影响。我们现在从顶层接近 ECS 答案。</p>
<h2 id="回到开始。"><a href="#回到开始。" class="headerlink" title="回到开始。"></a>回到开始。</h2><p>我们的“面向对象架构”在 Rust 中完全失败了，让我们从我们知道会起作用的东西开始，我们的“UR-架构”，并尝试改进它。这是一个相当标准的 ECS 转换，你可能以前见过。</p>
<p>我读过很多 ECS 解释，我知道有一个相当好的解释，还有 <em>很多</em> 真正令人困惑的糟糕解释，希望我可以以一种很好的方式解释这个，专注于 <em>数据</em> 表示，并且对 Rust 特别有用。</p>
<p>让我们从我们的简单“Starbound”开始，再次写下我们游戏的状态表示，但这次是用 Rust。没有方法，没有函数，只有数据类型。这将与上面的 Mario 64 示例“UR-架构”非常相似，有一些小的添加：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">EntityIndex</span> = <span class="type">usize</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Physics</span> &#123;</span><br><span class="line">    position: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    velocity: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    mass: <span class="type">f32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidAnimationState</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidItem</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidState</span> &#123;</span><br><span class="line">    animation_state: HumanoidAnimationState,</span><br><span class="line">    left_hand_item: HumanoidItem,</span><br><span class="line">    right_hand_item: HumanoidItem,</span><br><span class="line">    aim_position: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    physics: Physics,</span><br><span class="line">    humanoid: HumanoidState,</span><br><span class="line"></span><br><span class="line">    health: <span class="type">f32</span>,</span><br><span class="line">    focused_entity: EntityIndex,</span><br><span class="line">    food_level: <span class="type">f32</span>,</span><br><span class="line">    admin: <span class="type">bool</span>,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">MonsterAnimationState</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DamageRegion</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Monster</span> &#123;</span><br><span class="line">    physics: Physics,</span><br><span class="line">    animation_state: MonsterAnimationState,</span><br><span class="line"></span><br><span class="line">    health: <span class="type">f32</span>,</span><br><span class="line">    current_target: EntityIndex,</span><br><span class="line">    damage_region: DamageRegion,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NpcBehavior</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Npc</span> &#123;</span><br><span class="line">    physics: Physics,</span><br><span class="line">    humanoid: HumanoidState,</span><br><span class="line"></span><br><span class="line">    health: <span class="type">f32</span>,</span><br><span class="line">    behavior: NpcBehavior,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Player</span>(Player),</span><br><span class="line">    <span class="title function_ invoke__">Monster</span>(Monster),</span><br><span class="line">    <span class="title function_ invoke__">Npc</span>(Npc),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Assets</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    assets: Assets,</span><br><span class="line"></span><br><span class="line">    entities: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;Entity&gt;&gt;,</span><br><span class="line">    players: <span class="type">Vec</span>&lt;EntityIndex&gt;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">game_state</span> = <span class="title function_ invoke__">initial_game_state</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">input_state</span> = <span class="title function_ invoke__">capture_input_state</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">player_control_system</span>(&amp;<span class="keyword">mut</span> game_state, &amp;input_state);</span><br><span class="line">        <span class="title function_ invoke__">npc_behavior_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line">        <span class="title function_ invoke__">monster_behavior_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">physics_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... 更多的系统</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">render_system</span>(&amp;<span class="keyword">mut</span> game);</span><br><span class="line">        <span class="title function_ invoke__">audio_system</span>(&amp;<span class="keyword">mut</span> game);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">wait_vsync</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>与 Mario 64 示例相比，这里有几个变化。首先，我们试图使用 Rust 功能，如枚举和像 Option 这样的数据类型，而不是如此努力地模仿 C。很棒的是，突然之间，我们游戏状态的结构有更少的可能无效状态！例如，如果我们试图使用一个统一的“Entity”与一个类型代码，像 Mario 64 那样，将会有必须手动保持的不变性，这些不变性表明某些字段的状态取决于实体的类型。现在，许多这些不变性自然地因为求和类型是如此伟大而消失了。这很有趣，因为它使封装变得不那么重要，即使一切都是公开的，也有一些不变的性不能被打破。还有一些不变的性不能以这种方式表达，例如，数组的玩家 ID 可能需要仅指向 Player 类型的实体！</p>
<p><code>entities: Vec&lt;Option&lt;Entity&gt;&gt;</code> 也很有趣。由于我们的一些实体将索引到这个数组作为对其他实体的“指针”，因此有意义我们不应该在数组中移动实体。如果我们分配了一堆实体然后删除了我们分配的第一个实体，我们不应该移动每个实体，而是将其设置为 None，这样数组的其余部分就会保持在原位。在分配时，我们可能会遍历数组寻找第一个 None 空槽，如果没有找到，将一个新的实体推到末尾。</p>
<p>这很有趣，因为它与“Mario 64”示例中的静态数组的工作方式非常相似。</p>
<p>除了这些变化，这并不是一个巨大的偏离。所有的游戏状态仍然在道德上是全局的，每个系统仍然可能是大的和程序化的。但这里的事情是……我真的不认为这很糟糕？</p>
<p>老实说，如果我正在做一个游戏制作比赛的游戏，这可能就是我会编写我的游戏的方式！</p>
<p>我不会编写底层图形或音频代码，但如果我正在做一个简单的 2D 游戏或非常简单的 3D 游戏，这对我来说是可行的。我的游戏状态可能是一个相当复杂的结构体，充满了其他结构体，我可能有很多“系统”（记住，这里只是普通函数）在不同的文件中，这很好。我会选择一个非常简单的图形 API，尽可能少的状态，以尽可能减少“加载”和“卸载”图形数据的麻烦，同样适用于音频 API，这将是游戏的结构。如果我必须使用一个非常混乱和有状态的图形或音频系统，我会在最初创建游戏状态时预加载所有内容，将所有内容都放在某个 Assets 结构体中，就这样。</p>
<p>有很多 Rust 的高级图形和声音 API 实际上使这变得非常容易。</p>
<p>但是，这种模式显然并不完美，除了一切都是全局公开的。首先，我们的每个实体类型中都有很多重复的数据，例如 <code>Physics</code> 在 Player、Monster 和 Npc 中重复。在我们的 <code>physics_system</code> 函数中，可能有一些共性，这进一步分解为另一个函数，但 <code>physics_system</code> 肯定 <em>肯定</em> 必须理解有 3 种不同的实体类型，它们都有物理。每当我们添加一个实体类型时，可能这个系统必须改变其实现，并且老实说，可能 <em>非常非常多</em> 的系统在添加实体类型时必须改变。</p>
<p>另外，随着我们添加更多的实体，我们可能会开始发现很大一部分将被一遍又一遍地重复。也许“Monster”太具体了，你将它分解为“FlyingMonster”和“GroundMonster”，但它们共享 80% 的相同字段，反过来，这两个又与 Player 共享 50% 的字段。</p>
<p>这在某些方面比拥有一个统一的实体类型要好，但在某些方面实际上更糟？这还不错，但让我们看看是否可以做得更好。让我们回到像 Mario 64 示例那样有一个统一的 Entity 类型：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">EntityIndex</span> = <span class="type">usize</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有不同类型的字段，一个实体可以拥有，按逻辑分组...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Physics</span> &#123;</span><br><span class="line">    position: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    velocity: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    mass: <span class="type">f32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidAnimation</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidItem</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">MonsterAnimationState</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DamageRegion</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NpcBehavior</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidState</span> &#123;</span><br><span class="line">    animation_state: HumanoidAnimation,</span><br><span class="line">    left_hand_item: HumanoidItem,</span><br><span class="line">    right_hand_item: HumanoidItem,</span><br><span class="line">    aim_position: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PlayerState</span> &#123;</span><br><span class="line">    focused_entity: EntityIndex,</span><br><span class="line">    food_level: <span class="type">f32</span>,</span><br><span class="line">    admin: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MonsterState</span> &#123;</span><br><span class="line">    current_target: EntityIndex,</span><br><span class="line">    animation_state: MonsterAnimationState,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NpcState</span> &#123;</span><br><span class="line">    behavior: NpcBehavior,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个实体是所有可能的实体字段的集合，我们让每个人都有一个选项。在这种情况下，</span></span><br><span class="line"><span class="comment">// 我们失去了一些类型安全性，因为这样可以表达更多的无效状态，其中一些组合可能没有意义。</span></span><br><span class="line"><span class="comment">// 另外，也许现在没有意义让一个实体缺少位置，所以即使在这里是可选的，所有实体都必须有物理。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    physics: <span class="type">Option</span>&lt;Physics&gt;,</span><br><span class="line">    health: <span class="type">Option</span>&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    humanoid: <span class="type">Option</span>&lt;HumanoidState&gt;,</span><br><span class="line">    player: <span class="type">Option</span>&lt;PlayerState&gt;,</span><br><span class="line">    monster: <span class="type">Option</span>&lt;MonsterState&gt;,</span><br><span class="line">    npc: <span class="type">Option</span>&lt;NpcState&gt;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Assets</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    assets: Assets,</span><br><span class="line"></span><br><span class="line">    entities: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;Entity&gt;&gt;,</span><br><span class="line">    players: <span class="type">Vec</span>&lt;EntityIndex&gt;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">game_state</span> = <span class="title function_ invoke__">initial_game_state</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">input_state</span> = <span class="title function_ invoke__">capture_input_state</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">player_control_system</span>(&amp;<span class="keyword">mut</span> game_state, &amp;input_state);</span><br><span class="line">        <span class="title function_ invoke__">npc_behavior_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line">        <span class="title function_ invoke__">monster_behavior_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">physics_system</span>(&amp;<span class="keyword">mut</span> game_state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... 更多的系统</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">render_system</span>(&amp;<span class="keyword">mut</span> game);</span><br><span class="line">        <span class="title function_ invoke__">audio_system</span>(&amp;<span class="keyword">mut</span> game);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">wait_vsync</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>好的，这很有趣。显然，我们在这里失去了一些不变性，因为更多的潜在无效实体可能会被创建，但有一些巨大的优势。一个突出的是，我们 <code>physics_system</code> 的实现可能大大简化了，只需循环遍历所有实体并突变 <code>physics</code> 字段（如果它们有的话）。这比循环遍历实体并匹配实体类型要简单得多。</p>
<p>仍然有一些结构仅对每种“逻辑”实体类型有效，显然，让某物同时是 NPC 和怪物是没有意义的，所以这是一个需要保持的不变性。这很有趣，因为每个“类型”的数据量变小了。让我们更进一步改变它，并分离出更多的字段：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Physics</span> &#123;</span><br><span class="line">    position: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    velocity: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">    mass: <span class="type">f32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidAnimation</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidItems</span> &#123;</span><br><span class="line">    left_hand_item: HumanoidItem,</span><br><span class="line">    right_hand_item: HumanoidItem,</span><br><span class="line">    aim_position: Vector2&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MonsterAnimation</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NpcBehavior</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Aggression</span> &#123;</span><br><span class="line">    current_target: EntityIndex,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了对称，让我们让 Health 成为结构体类型</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Health</span>(<span class="type">f32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Hunger</span> &#123;</span><br><span class="line">    food_level: <span class="type">f32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PlayerState</span> &#123;</span><br><span class="line">    focused_entity: EntityIndex,</span><br><span class="line">    admin: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    physics: <span class="type">Option</span>&lt;Physics&gt;,</span><br><span class="line">    huamnoid_animation: <span class="type">Option</span>&lt;HumanoidAnimation&gt;,</span><br><span class="line">    humanoid_items: <span class="type">Option</span>&lt;HumanoidItems&gt;,</span><br><span class="line">    monster_animation: <span class="type">Option</span>&lt;MonsterAnimation&gt;,</span><br><span class="line">    npc_behavior: <span class="type">Option</span>&lt;NpcBehavior&gt;,</span><br><span class="line">    health: <span class="type">Option</span>&lt;Health&gt;,</span><br><span class="line">    hunger: <span class="type">Option</span>&lt;Hunger&gt;,</span><br><span class="line">    player: <span class="type">Option</span>&lt;PlayerState&gt;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以有很多方法可以表达每个实体可能包含的字段，它们都有优点和缺点。在这种情况下，通过以这种方式转换我们的字段类型，有几件事情变得可以表达，以前是不可能的！例如，由于我们将 <code>food_level</code> 字段从 Player 中分离出来并称之为 <code>Hunger</code>，我们现在可以表达不是 Player 但饥饿的实体，所以现在我们可以描述饥饿的 NPC。另外，在分离出 <code>Aggression</code> 之后，我们可以表达敌对的 NPC！</p>
<p>然而，也许我们可以表达具有怪物类型动画的东西，也可以携带人类物品，也许这实际上是逻辑上无效的，所以这里有一个取舍。尽管如此，这仍然很有趣，并解决了在需要重复代码来表达或从单一类型中提取的实体类型之间存在很多共同性的问题。</p>
<p>现在，可能已经很清楚我要去哪里了，但这种模式，其中实体由一个或多个命名部分组成，并且它们是按需指定的，是非常常见的。实际上，这些部分通常被称为“组件”！我们现在有了所有的实体、组件和系统，所以如果你眯着眼睛看，这就是一个“ECS”系统所需要的一切，但这实际上非常简单！通过专注于我们状态的数据表示，这与我们开始的没有太多步骤。</p>
<p>让我们再做一个实际上无关紧要的改变，但这将在一秒钟内帮助我们。此外，我们将开始称我们一直在定义的所有这些部分为“组件”，以强化这一点：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhysicsComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidAnimationComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidItemsComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MonsterAnimationComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NpcBehaviorComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AggressionComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HealthComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HungerComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PlayerComponent</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">EntityIndex</span> = <span class="type">usize</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Assets</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    assets: Assets,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有这些组件向量必须具有相同的长度，这是当前的实体数量。</span></span><br><span class="line">    physics_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;PhysicsComponent&gt;&gt;,</span><br><span class="line">    humanoid_animation_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;HumanoidAnimationComponent&gt;&gt;,</span><br><span class="line">    humanoid_items_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;HumanoidItemsComponent&gt;&gt;,</span><br><span class="line">    monster_animation_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;MonsterAnimationComponent&gt;&gt;,</span><br><span class="line">    npc_behavior_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;NpcBehaviorComponent&gt;&gt;,</span><br><span class="line">    aggression_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;AggressionComponent&gt;&gt;,</span><br><span class="line">    health_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;HealthComponent&gt;&gt;,</span><br><span class="line">    hunger_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;HungerComponent&gt;&gt;,</span><br><span class="line">    player_components: <span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;PlayerComponent&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    players: <span class="type">Vec</span>&lt;EntityIndex&gt;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是经典的“结构数组”到“数组结构”的转换。应该很清楚（几乎）完全相同的信息可以在这两种表示之间表达。有一些新的不变性需要维护，即每个组件 Vec 的长度必须相同，但并没有真正的新信息。当你像这样写出类型时，这些变化实际上看起来相当简单，而不是在我们的面向对象架构中，像这样的变化可能被认为是不可能的重构。显然我们还需要在这里改变很多系统，每次我们进行这些更改时，但能够独立思考数据是有价值的。</p>
<p>“数组结构”的转换通常是 ECS 介绍中真正关注的，然后他们开始谈论性能问题和缓存行为，这可能会有点令人困惑和不知所措。他们不是错了，但我不认为这是重要的部分。这就是为什么我以这种方式介绍 ECS，因为我认为很多解释都错过了这一点，从某种角度看，这些变化实际上相当无聊和正常。你可能有这种结构，或者你可能有之前的结构，也许一个比另一个性能更好，但你没有通过选择一个而不是另一个来彻底改变编程范式。从数据导向的角度来看，这些事情并不是颠覆性的，它们只是性能优化。这里还有很多其他的潜在优化可以做，但我认为我们已经达到了有人可能会称之为“ECS 系统”的最低限度。</p>
<p>这里有一些对 Rust 用户的一般性建议，不仅仅是游戏开发者：</p>
<ul>
<li><p>仅仅思考状态的结构是非常有力的，通常“方法”和“对象”会碍事。没有人会认为在结构体上拥有方法是“太多的面向对象”，但它确实将你的程序与你的耦合在一起，即使只是组织上的。数据结构设计和简单的模块组织都很重要，但不要将它们混为一谈！我确信“ECS 设计”在游戏开发中如此出色，是因为它迫使你思考你的数据而不是被卡在面向对象模式中，而不是“数组结构”的魔力。这是可以应用于 Rust 一般性的一个教训。</p>
</li>
<li><p>你可以用索引到 Vec 的方式做很多事情。这比自我借用或 Rc&lt;Ref</p>
</li>
<li><p>Cell&gt; 容易得多。</p>
<p>好的，让我们停下来谈谈 <code>EntityIndex</code>。我真的认为，大多数时候当你发现自己在 Rust 中遇到自我借用时，普通的 Vec 和索引应该是你首先使用的工具。还有其他工具，比如各种竞技场 crates，租赁等，但我认为通常你应该先尝试 Vec。一般来说，这些问题发生在你试图表示某种图结构时（ECS 只是一个非常平的图……有点），即使在 C++ 中，这通常也是给出的建议！（见 Andrei Alexandrescu 的性能演讲，他最喜欢的数据结构在世界上是 std::vector，“只使用 vector！”）像竞技场分配器这样的工具很棒，实际上非常高效，并且有可以与多种类型一起使用的版本，但它们不能是 ‘static 除非添加自我借用。自我借用解决方案像租赁是 _最后的手段_。这不值得，继续你的生活，只是使用 Vec 和索引。</p>
<p>话虽如此，它们确实有一些缺点。在我们的实体示例中，我们一直对如何找到“空闲” EntityIndexes 以及“删除”如何工作这个问题视而不见，因为实际上并不那么好。分配一个“实体”的成本不是恒定的，因为我们必须扫描 Vec 寻找空闲条目。删除实体更便宜，但它有不好的特性。我们可以删除一个实体，这会释放 Vec 中的一个插槽，但然后可能的情况是下一个分配的实体将使用相同的索引。如果我们在删除之前确保没有未解决的“索引引用”到这个实体，这很好，但如果我们搞砸了呢？我们将在不知不觉中得到一个“随机其他实体”，而无法告诉它实际上被从我们下面移除了！另外，这两种情况在“数组结构”转换后变得更糟，因为现在我们有多个数组而不是一个，以及我们如何管理“实体索引”现在是悬而未决的。我们将同时解决这两个问题。</p>
<h2 id="代际索引是很棒的。"><a href="#代际索引是很棒的。" class="headerlink" title="代际索引是很棒的。"></a>代际索引是很棒的。</h2><p>所以这是我最喜欢的模式之一，我不确定在 Rust 社区中是否广为人知，但我相信在游戏开发中广为人知。</p>
<p>我们一直在使用 <code>EntityIndex</code> 来识别和查找存储在 Vec 中的实体。这非常类似于我在 C++ mini-Starbound 中使用的模式，我使用了一个 <code>EntityId</code>，这是一个递增的整数 ID 来存储实体，像这样：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;EntityId, shared_ptr&lt;Entity&gt;&gt; entities;</span><br></pre></td></tr></table></figure>

<p>两者都是从整数到某些值的抽象映射。在 Vec 的情况下，它基本上是最快可能的数据结构，索引到数组，而在 <code>HashMap</code> 的情况下，它要慢得多，但 <code>HashMap</code> 要灵活得多！首先，只有总条目数的上限，而不是，比如说，索引的最大大小。<code>HashMap</code> 可以很好地工作，如果你从 1,000,000,000 或 1 开始键值。这在上述删除问题中很重要。如果我们使用 <code>HashMap</code> 和键类型 <code>u32</code> 或甚至 <code>u64</code> 来索引，我们可以只让新索引始终递增（最终会回绕）。这样，你可以或多或少地保证没有索引会被重新使用，或者至少在索引被重新使用之前会是“很长一段时间”。在 <code>u64</code> 的情况下，如果你重新使用了一个索引，你的游戏技术可能已经有“云”在名称中，所以你可能有更多的问题：)。但是 <code>HashMap</code> 比 Vec 慢 :(</p>
<p>是否有办法在使用整数索引到 Vec 的情况下获得这种属性？有，它被称为“代际索引”！</p>
<p>而不是只使用一个整数索引，我们制作一个“代际索引”类型，像这样：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 你可以使用其他类型，如果这些类型对于 usize / u64 来说太大</span></span><br><span class="line"><span class="meta">#[derive(Eq, PartialEq, etc...)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">GenerationalIndex</span> &#123;</span><br><span class="line">    index: <span class="type">usize</span>,</span><br><span class="line">    generation: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">GenerationalIndex</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">index</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后，我们制作一个叫做“代际索引分配器”的东西：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">AllocatorEntry</span> &#123;</span><br><span class="line">    is_live: <span class="type">bool</span>,</span><br><span class="line">    generation: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">GenerationalIndexAllocator</span> &#123;</span><br><span class="line">    entries: <span class="type">Vec</span>&lt;AllocatorEntry&gt;,</span><br><span class="line">    free: <span class="type">Vec</span>&lt;<span class="type">usize</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">GenerationalIndexAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">allocate</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> GenerationalIndex &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回 true 如果索引之前被分配过，现在被释放了</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">deallocate</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, index: GenerationalIndex) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_live</span>(&amp;<span class="keyword">self</span>, index: GenerationalIndex) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（有更快的实现方式，但这一个实际上相当不错。另外注意，这是数据隐藏的一个明显好的用途）。</p>
<p>基本思想是你可以“分配”向量索引就像你有了 <code>Vec&lt;Option&lt;Entry&gt;&gt;</code>，但你会永远不重新使用索引。它的工作原理是这样的，你分配一个索引并得到一个带有真实索引 0 的 <code>GenerationalIndex</code>，它也会有“代”0。如果你删除那个索引，它会进入一个空闲索引池，所以下次你分配一个索引时，你可能会得到另一个带有真实索引 0 的代际索引，但关键是代际现在将是 1。代际索引永远不会被重新使用，因为代际总是会递增，然而“真实索引”将始终是“小的”，在最大总条目数的顺序上。这样，你可以使用快速索引到 Vec 而没有简单索引的许多“指针样”属性！</p>
<p>我说这种模式在 Rust 社区中不是广为人知，但至少有一点谎言，因为有一个最近发布的 crate 建立在这个想法上叫做“slotmap”，它很棒！但是，它缺少一个对我们的例子至关重要的功能，那就是在“slotmap”中，你只能为特定的 SlotMap 分配索引，你不能分配索引并重新使用它们用于不同的 SlotMaps。有用，但如果这些概念是分开的，就像我们在这里概述的那样，它将更有用得多。索引到 Vec 已经是在遇到“自我借用”时应该首先使用的工具，代际索引使它变得更好。“slotmap”比我先发布了一个 crate：(，所以这算是一个功能请求 :)</p>
<p>我们将继续制作一个比 <code>Vec&lt;Option&lt;T&gt;&gt;</code> 更易于使用的类型，以存储我们的实际数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ArrayEntry</span>&lt;T&gt; &#123;</span><br><span class="line">    value: T,</span><br><span class="line">    generation: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从 GenerationalIndex 到一些 Value T 的关联数组。</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">GenerationalIndexArray</span>&lt;T&gt;(<span class="type">Vec</span>&lt;<span class="type">Option</span>&lt;ArrayEntry&lt;T&gt;&gt;&gt;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; GenerationalIndexArray&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// 为某个代际索引设置值。可能会覆盖过去的代际值。</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">set</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, index: GenerationalIndex, value: T) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取某个代际索引的值，代际必须匹配。</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>, index: GenerationalIndex) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;T&gt; &#123; ... &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, index: GenerationalIndex) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以有了这个新的抽象，让我们再次改变我们的引擎：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhysicsComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidAnimationComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidItemsComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MonsterAnimationComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NpcBehaviorComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AggressionComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HealthComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HungerComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PlayerComponent</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们放弃了索引或 ID 后缀，因为没有其他“实体”类型会混淆。 但不要忘记，这并不“包含”</span></span><br><span class="line"><span class="comment">// 任何东西，它只是一种索引或 ID 或句柄或任何你想要的称呼。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Entity</span> = GenerationalIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从 Entity 到某种类型 T 的映射</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">EntityMap</span>&lt;T&gt; = GenerationalIndexArray&lt;T&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    assets: Assets,</span><br><span class="line"></span><br><span class="line">    entity_allocator: GenerationalIndexAllocator,</span><br><span class="line"></span><br><span class="line">    physics_components: EntityMap&lt;PhysicsComponent&gt;,</span><br><span class="line">    humanoid_animation_components: EntityMap&lt;HumanoidAnimationComponent&gt;,</span><br><span class="line">    humanoid_items_components: EntityMap&lt;HumanoidItemsComponent&gt;,</span><br><span class="line">    monster_animation_components: EntityMap&lt;MonsterAnimationComponent&gt;,</span><br><span class="line">    npc_behavior_components: EntityMap&lt;NpcBehaviorComponent&gt;,</span><br><span class="line">    aggression_components: EntityMap&lt;AggressionComponent&gt;,</span><br><span class="line">    health_components: EntityMap&lt;HealthComponent&gt;,</span><br><span class="line">    hunger_components: EntityMap&lt;HungerComponent&gt;,</span><br><span class="line">    player_components: EntityMap&lt;PlayerComponents&gt;,</span><br><span class="line"></span><br><span class="line">    players: <span class="type">Vec</span>&lt;Entity&gt;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>太棒了！我们现在几乎是一个完整的 ECS 系统。</p>
<p>对 Rust 用户的收获：显然代际索引是很棒的，但出于某种原因它们在 C++ 中更受欢迎，但它们可能对 Rust 更有用！对“slotmap”的作者，请将分配器单独公开，这非常有用！如果这不在你的范围或你想要的 API 提供，我可以发布一个类似的 crate，它可以做到这一点。</p>
<h2 id="动态类型在非常受控的数量中实际上是相当不错的。"><a href="#动态类型在非常受控的数量中实际上是相当不错的。" class="headerlink" title="动态类型在非常受控的数量中实际上是相当不错的。"></a>动态类型在非常受控的数量中实际上是相当不错的。</h2><p>好的，我们现在非常接近一个“真正的” ECS 系统（像 specs！）可能的工作方式。我们还没有解决的最大问题仍然是一切都是相当全局的。更重要的是，每个“系统”（对我们来说，仍然只是一个普通函数的花哨名称）都依赖于我们游戏状态中的 <em>所有</em> 类型，这可能是相当大的。大多数游戏将生活在一个 crate 中，这些模块之间的依赖关系图表真的没有什么好担心的，但仍然改变“GameState”中的任何内容至少 <em>理论上</em> 会影响每个系统。</p>
<p>让我们看看我们能做些什么？</p>
<p>我想强调一下，在我们继续之前，这是 _可选的_。你可能会觉得这是不必要的复杂性，你可能是对的！这确实是大多数 ECS 实现中的东西，所以它值得涵盖，只是为了理解它们，并且当试图构建一个库来做到这一点时，它是 <em>或多或少</em> 无法避免的。</p>
<p>为此，我们需要 <code>anymap</code> crate，但 <code>mopa</code> crate 也会起作用。我们需要一个容器，可以存储我们放入其中的 <em>每种</em> 类型的一个精确副本：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">AnyMap</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">AnyMap</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">insert</span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, t: T) &#123; ... &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get</span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;T&gt; &#123; ... &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> T&gt; &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们如何使用这个来存储我们的组件？</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PhysicsComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidAnimationComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HumanoidItemsComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MonsterAnimationComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NpcBehaviorComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AggressionComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HealthComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HungerComponent</span> &#123; ... &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PlayerComponent</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Entity</span> = GenerationalIndex;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">EntityMap</span>&lt;T&gt; = GenerationalIndexArray&lt;T&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">GameState</span> &#123;</span><br><span class="line">    assets: Assets,</span><br><span class="line"></span><br><span class="line">    entity_allocator: GenerationalIndexAllocator,</span><br><span class="line">    <span class="comment">// 我们假设这将只包含 `EntityMap&lt;T&gt;` 类型的类型。 这是动态的，所以类型系统在这里不再有帮助，</span></span><br><span class="line">    <span class="comment">// 你可以使用 `mopa` crate 使这稍微更好。</span></span><br><span class="line">    entity_components: AnyMap,</span><br><span class="line"></span><br><span class="line">    players: <span class="type">Vec</span>&lt;Entity&gt;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在，而不是存储游戏特定的数据，让我们继续使用动态类型！我们将说我们的游戏状态是一个动态集合的实体与组件，并且 <em>也</em> 是其他类型的动态集合，每种类型一个。我们将这些称为“资源”。我们还将 <code>GameState</code> 的名称更改为更准确的东西。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Entity</span> = GenerationalIndex;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">EntityMap</span>&lt;T&gt; = GenerationalIndexArray&lt;T&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ECS</span> &#123;</span><br><span class="line">    entity_allocator: GenerationalIndexAllocator,</span><br><span class="line">    <span class="comment">// 充满了像 `EntityMap&lt;T&gt;` 这样的类型。</span></span><br><span class="line">    entity_components: AnyMap,</span><br><span class="line"></span><br><span class="line">    resources: AnyMap,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们到达了一个实际的 ECS 数据结构可能看起来的样子。</p>
<p>我添加了一个“资源” AnyMap，因为这也是很常见的模式，它意味着你的整个游戏状态可以在这个“ECS”结构中表达。我们称它为“ECS”，但重要的是，真的没有提到“系统”。我实际上不喜欢通过谈论行为来描述 ECS，因为我认为虽然它可能很重要，但它真的是次要的。如果我们的“系统”是纯函数在一个循环中，或者它们是更花哨的东西，这两种都捕捉到了 ECS 设计的重要部分。</p>
<p>所以，你现在可能会对动态类型的引入感到不满和突然。让我们停下来想想这给我们带来了什么。假设你为你的游戏得到了一个新的功能请求，比如说你需要一个新的疯狂的特殊怪物，它有一些内部的计数器。每次你杀死怪物时，它会将自己复制成两个并递减计数器，像九头蛇的头一样复制。这意味着你可能需要一个新的组件类型，比如说 <code>EnemyDuplicationLevel</code> 或其他什么。有了动态类型，你可以添加这个组件而不会“打扰”你的其他系统，因为如果没有导入新模块，它们不可能“看到”ECS 有这样一个组件。资源也是如此，你可以向你的模型添加新数据类型而不会“打扰”现有的系统。</p>
<p>这种论证的理由可能看起来相当薄弱，而且确实如此。为了获得完整的画面，我们需要更进一步。我将加快速度，这样我们可以到达结尾，我可以展示一个完整的画面，我认为这是一个“现代”游戏引擎设计，你可能用于中型或大型项目。它实际上并不比这更远，但最后几个功能都是相关的，单独使用它们并不那么有用。</p>
<h2 id="“注册表”模式"><a href="#“注册表”模式" class="headerlink" title="“注册表”模式"></a>“注册表”模式</h2><p>现在我们已经引入了动态类型，这里有一个我喜欢的设计模式，我认为在 Rust 中还没有真正看到过（我确定它存在，我只是没有看到）。我将称其为“注册表模式”。</p>
<p>在像 specs 这样的 ECS 实现中，有一个步骤，你“注册”一个类型与你的 ECS，这会在某个 AnyMap 或相当于 AnyMap 的地方插入一个条目。使用未注册的组件类型通常是一个错误。让我们再进一步，不要将“注册”与 ECS 本身联系起来，让我们制作我们自己的“注册表”。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ComponentRegistry</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ComponentRegistry</span> &#123;</span><br><span class="line">    <span class="comment">// 注册一个组件，组件必须实现一个特殊特征才能允许</span></span><br><span class="line">    <span class="comment">// 例如从 JSON 配置中加载。</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">register_component</span>&lt;T: Component&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为所有注册的组件设置 ECS 的条目</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">setup_ecs</span>(&amp;<span class="keyword">self</span>, ecs: &amp;<span class="keyword">mut</span> ECS) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从给定的配置中加载一个实体到给定的 ECS</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">load_entity</span>(&amp;<span class="keyword">self</span>, config: Json, ecs: &amp;<span class="keyword">mut</span> ECS) <span class="punctuation">-&gt;</span> Entity &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们也将为“资源”做一个</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ResourceRegistry</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ResourceRegistry</span> &#123;</span><br><span class="line">    <span class="comment">// 资源特征提供从 JSON 和其他东西中加载。</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">register_resource</span>&lt;T: Resource&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为所有注册的资源设置 ECS 的条目</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">setup_ecs</span>(&amp;<span class="keyword">self</span>, ecs: &amp;<span class="keyword">mut</span> ECS) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过从给定的配置中加载来向给定的 ECS 添加资源。</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">load_resource</span>(&amp;<span class="keyword">self</span>, config: Json, ecs: &amp;<span class="keyword">mut</span> ECS) &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后，我们将它们在一个大型的全局常量中使用 lazy_static 绑定在一起！</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当我们向项目中添加一个组件时，有两个步骤。首先，将组件添加到某个地方作为一个 Rust 模块，然后将其添加到这个列表中。为了增加便利性，这个函数可以放在包含组件模块本身的 lib.rs 中。如果你非常花哨，你也可以有一些“插件架构”来实现这一点，将相关的组件 / 资源组合在一起成为“插件”。</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">load_component_registry</span>() <span class="punctuation">-&gt;</span> ComponentRegistry &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">component_registry</span> = ComponentRegistry::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    component_registry.register::&lt;PhysicsComponent&gt;();</span><br><span class="line">    component_registry.register::&lt;PlayerComponent&gt;();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同上</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">load_resource_registry</span>() <span class="punctuation">-&gt;</span> ResourceRegistry &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Registry</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> components: ComponentRegistry,</span><br><span class="line">    <span class="keyword">pub</span> resources: ResourceRegistry,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> REGISTRY: Registry = Registry &#123;</span><br><span class="line">        components: <span class="title function_ invoke__">load_component_registry</span>(),</span><br><span class="line">        resources: <span class="title function_ invoke__">load_resource_registry</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我喜欢这种模式，因为如果你眯着眼睛看，这几乎就像你在 Java 中可能找到的全局类型注册表。它感觉有点“企业级”，但非常有用！它也类似于具有内置编辑器的全功能、全面的引擎，你可能会通过某些菜单或 GUI 添加组件类型，它最终会存储在某些项目配置文件中。在这种情况下，而不是项目配置文件，它只是一个辅助的 Rust 代码。</p>
<p>这种模式最终非常有用！想象一下你有一些可以从 JSON 配置文件中加载的游戏状态。每个资源和组件都可以从 JSON 中加载，所以你只需要添加一个组件或资源类型，然后添加条目到数据格式，加载游戏并看到它（除了你需要一个新的系统来理解新类型，我们会在几秒钟内到达）。</p>
<p>所以到目前为止，这是一个正在变成“真正的”ECS 游戏引擎的东西的草图。我喜欢这个，因为到目前为止，除了一些必要的库功能外，我几乎没有谈论过函数或系统！我之所以这样做，是因为我不喜欢通过谈论行为来引入这个概念，我真的认为考虑我们如何描述我们的状态是一种更有用的方法来接近这个。</p>
<p>有了这个，很容易看出你如何也可以很容易地添加一个 <code>SystemRegistry</code> 与之相匹配。我们的系统只是函数，所以这将允许你以稍微更复杂的方式将函数添加到你的主循环中。这里可能的一个补充是允许系统有一些配置，这样你也许可以为它们配置可调参数，甚至使用相同的函数多次，但具有不同的参数。然而，通常建议尽量不要给你的系统 _状态_，这样你可以将你的游戏状态限制为组件和资源。如果你的游戏状态只是组件和资源，你通常可以做一些很酷的事情，比如克隆它们（像模拟器一样保存状态！）或轻松地序列化它，这在像系统闭包这样的东西中更难实现。</p>
<p>对普通 Rust 的收获：注册表模式实际上相当不错。在 Starbound 中有一个“根”对象，它有点像这个，每个类型都注册了，但它比这里描述的更具有状态性。它是只读的，但它是通过读取资产构建的。我实际上喜欢“类型注册表”的想法，当你想使用 AnyMap 这样的动态类型时，这是必要的，这两种模式很好地结合在一起，以限制“一切都依赖于一切”的问题。</p>
<h2 id="ECS-是游戏的-SQL"><a href="#ECS-是游戏的-SQL" class="headerlink" title="ECS 是游戏的 SQL"></a>ECS 是游戏的 SQL</h2><p>让我稍微揭开帷幕。我们到目前为止描述了什么：一种声明特殊类型键（实体）的方式，以及与这些键相关联的一系列记录（组件），另外还有定义不与这些键配对的记录的方式（资源）。我们引入了动态类型，并展示了一种模式，让你可以在一个地方定义你拥有的所有记录类型（有点像模式）。在我构建的真正的 ECS 中，我甚至有执行组件的原始“查询”的方式，比如说“给我所有具有位置的实体，可选具有速度，但不具有质量”。</p>
<p>这听起来可能非常熟悉，如果确实如此，有很好的理由。ECS 就是游戏的 SQL。一个非常、非常、非常有限的 SQL 形式，但精神上非常相似。定义你的</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>数据模式，加载它，对它进行查询，然后更新它。非常有限的 SQL，其中每个查询可能必须在不超过几微秒的时间内运行。</p>
<p>我早些时候说过我读过很多糟糕的 ECS 介绍和一个好介绍。我不是第一个提到 ECS 和 SQL 之间平行的人，早在 2009 年，就有一篇文章关注 MMO 的这一点。</p>
<p>所以，如果这是真的，我们为什么不能只使用像 sqlite 这样的来存储我们的游戏状态？有趣的是，你可能真的可以做到这一点，但很难在 16 毫秒内运行查询足够快。让我们想想这将带来什么好处！哦，天哪，我需要为游戏制作一个保存格式..不，它是 SQL，我已经完成了。哦，我需要更新每个人的保存文件格式..写一些外部 SQL 更新脚本，你已经完成了！</p>
<p>哦，我想给游戏的任意状态保存的能力？完成了。我注意到一个错误，我想将游戏状态回滚到 30 秒前，然后逐步通过它，运行查询以查看何时产生了一个坏状态？完成了。所有这些仔细引入的代际索引概念，SQL 已经有了，它们是具有自动递增的键（更像是 <code>HashMap&lt;EntityId, T&gt;</code> 真的）。</p>
<p>那时，你的每个系统基本上将是一系列查询，从 SQL 中获取数据，进行一些更新，然后将其写回 SQL。我们已经将性感的游戏开发变成了无聊的老式 web 开发！（web 开发可以是性感的，游戏开发可以是无聊的，只是记录）</p>
<p>唯一的问题是我 <em>相当</em> 确定它慢了大约两个数量级，无法工作，但它是一个不错的想法，并且它是有用的，可以进行比较！</p>
<p>我认为这很重要，因为我看到很多关于“什么使某物成为纯粹的 ECS”的辩论，我认为这最终是非常愚蠢的。</p>
<ul>
<li><p>如果实体可以有多个组件，它是 ECS 吗？好吧，多个组件和只包含 Vec 的组件之间的差异非常非常少，但它仍然是 ECS。如果你有两个表是 1 到 N 而不是 1 到 1，它仍然是 SQL 吗？是的，当然。</p>
</li>
<li><p>如果我的组件有方法，它仍然是 ECS 吗？是的，添加组件方法并不是世界末日，特别是如果有一个小的局部不变性需要维护。SQL 是关于数据的，但它也有存储过程来维护不变性。</p>
</li>
<li><p>如果我需要两个不同的 ECS 集合，或者我把很多数据放入资源中，它仍然是 ECS 吗？我应该使用“单例实体”还是资源？它仍然是 SQL 如果我有两个不同的数据库，或者分开一个顶级表吗？是的，当然！</p>
</li>
</ul>
<p>……等等</p>
<p>这个类比不是完美的，但我认为这确实是一种启示。目前正在进行有关如何使更有能力的 ECS 系统具有组件图和组件与实体之间的子关系等的研究，当然这是可以的。SQL 已经有了所有这些，它是一种语言和一套软件，用于表达 <em>所有种类</em> 的数据关系，只是游戏通常有更简单的需求，将基本上总是在内存中，并且有纳秒或微秒的时间要求，所以我们妥协并制作了新工具。</p>
<p>这是另一个我做这次演讲的原因，帮助进一步揭开“ECS”的神秘面纱，并展示我们是如何来到这里的，并给出一些观点。</p>
<h2 id="一切都出错的地方"><a href="#一切都出错的地方" class="headerlink" title="一切都出错的地方"></a>一切都出错的地方</h2><p>（注意：我不知道我是否需要这一段，我只是在兜售我想要做的 <em>其他</em> 演讲。也许这不重要？这次演讲已经可能非常非常长了）</p>
<p>我一开始就声称，我见过的态度对借用检查器过于怀疑，认为它太限制性，这是胡说八道。我仍然绝对相信这一点，但我想快速谈谈我不断遇到问题的唯一地方，我真的 <em>只有</em> 遇到麻烦的地方，我不断感到受限。当然，随着项目规模的增长，<em>某些事情</em> 必须出错，对吧？好吧，我有一个例子，尽管这个问题并不局限于 Rust，它只是更 <em>立即</em> 痛苦（注意到一个模式？）。</p>
<p>语言边界很难。</p>
<p>所以，这里的问题都很难简洁地解释。我不确定我能否像以前一样提出小而有限的例子，而不深入到细节中，并使这次演讲的长度翻倍。我写了一个完整的 crate（rlua）来尝试解决这个问题，经过大量的工作，我可以自信地说我 <em>某种程度上</em> 只解决了一半。</p>
<p>我有一个组件的表示，你可以选择读取或写入每个组件（它们存储在 RwLocks 中以实现系统并发）。我想让 Lua 能够读取一组系统，所以我有一个 Lua 脚本对 ECS 存储执行“查询”。我所需要做的就是能够将 Lua 传递“RwLockReadGuard”（实际上是包含这个的结构）的查询返回，但是……</p>
<p>RwLockReadGuard 不是静态的。哦，我猜我只能在查询 API 中而不是在开始时一次性传递 Lua 查询锁定……那将是非常慢的，也不安全，查询应该在整个时间内锁定。我猜我可以使用租赁 crate……哦，天哪，租赁 crate 很难，这太可怕了。（后来我能够使用 rlua 的“范围”系统解决这个问题，但仍然很糟糕）。</p>
<p>最好你的系统不要有状态，对吧？通常系统应该将数据存储在它们操作的组件中，如果它们逻辑上相关，或者可能存储在自定义资源中，或者简单地存储一些缓存值，但要准备好如果系统重新加载，缓存将被重置。不要依赖不能被保存 &#x2F; 恢复 &#x2F; 序列化的数据。这很棒，直到你写了一个 Lua 系统，因为将值从 Lua 中提取出来实际上是真的很难。你不能将 Lua 状态存储在资源中，因为它不是 Sync，你也不能将 Lua 数据与状态分开存储，因为 Lua 内部状态和外部句柄真的不是 Sync。你可以使用一些神奇的 Lua 注册表键来解决这个问题，但如果你每个系统都有自己的 Lua 实例，如果你尝试在错误的上下文中使用 Lua 值，你就制造了一个脚枪，而且它们也不是可序列化的。</p>
<p>你可以制作一个数据类型，它仅限于数据而不是内部 Lua 类型，但然后你必须在它和非 lua 表示之间编写编组，所以每次你的脚本系统读取或写入这个存储，它都是 <em>非常慢</em> 的。一些慢速是来自复制数据，但大部分是来自本质上的 Lua API 慢速。</p>
<p>一切都很难，如果你真的尝试，它是可以工作的，但你感觉它应该比这更简单。这甚至比 C++ 中的等价物更难，但 C++ 中的等价物实际上和这一样糟糕，你只是在 Rust 中更快地注意到它。</p>
<p>至少没有不断的崩溃和 shared_ptr 循环了？</p>
<p>看起来有点类似于我们之前的情况，我们尝试了面向对象的错误方法。不幸的是，在 rlua 的情况下，有一些基于 Lua 内部 C API 如何工作的硬性限制，它可能接近我能提供的最好的东西。</p>
<p>语言边界很难，尤其是当它们有非常不同的限制集合的语言之间，比如 Rust 和 Lua（或 C++ 和 Lua）。特别是当被包含语言中的垃圾收集器与宿主语言中的垃圾收集器接触时，一切都不会工作，什么都不会被收集。（在 C++ &#x2F; Rust 中，这是 shared_ptr &#x2F; Arc，是的，这些是一种垃圾收集器）</p>
<p>我提到这个是因为我认为 Lua 非常受游戏开发者的欢迎，我经常收到关于如何将 rlua 与像 specs 这样的东西结合的问题，我认为这真的很难，并且违背了我在这次演讲中提出的更大观点。我认为这可能是 <em>独特地</em> 难，因为语言边界非常棘手，情况并不比 C++ 中的更糟或更好，它稍微更难，但更安全，只是稍微更难不是一个很好的答案，当在 C++ 中它仍然非常困难时。</p>
<p>我还提到这个，因为我可能很快就会有一个答案！我考虑做的 <em>另一个</em> 演讲是描述我认为是一种新颖的方式，在 Rust 中安全地实现语言运行时，它们有垃圾收集，并且是零成本的，并且具有快速、大部分无痛（或尽可能）的绑定体验。</p>
<p>与此同时，在你添加游戏引擎的脚本层之前，请仔细考虑。问题是，我 <em>爱</em> 游戏引擎中的脚本层（出于可修改性和许多其他原因），所以我无论如何都会这样做，但这不是一个轻松的决定，它可以消耗大量的时间和精力。我想让这更无痛，并且使一个安全、快速的 Lua 在 Rust 中感觉像家一样，就像 PUC-Rio 的 Lua 在 C 中感觉像家一样。我将来会谈论这个！</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我这次演讲有多个目的：</p>
<ul>
<li>为那些只有小规模项目经验的人，走过一个中等规模 Rust 项目的设计理念。</li>
<li>展示一些陷阱的例子，人们可能会陷入其中，从而“与借用检查器战斗”，并帮助更具体地了解如何至少部分地越过这个阶段。</li>
<li>展示数据导向编程有多么棒，以及它对游戏和 Rust 是多么合适的</li>
<li>展示在 Rust 中应用的游戏开发模式，这些模式在 Rust 出现之前就已经出现了，仍然似乎是一个很好的选择。</li>
</ul>
<p>我谈论了很多在其他语言中经过艰苦斗争的模式，只有在费力地探索了最终不成功的解决方案的空间后才会出现。有趣的是，那些最终效果不佳的解决方案通常会更快地在 Rust 中引起痛苦，它们更响亮，更烦人。我认为这是一件好事，我喜欢有工具让糟糕的模式感觉和它们一样糟糕。Rust 在这方面 _很棒_。</p>
<p>但你可以把这里的大部分教训同样容易地应用在 C++ 中吗？在 C 中吗？是的，绝对可以。即使你是那种即使没有这种语言压力也不会犯这些错误的人（你比我强多了），还有很多其他的好处。</p>
<p>我实际上没有机会谈论 Rust 的所有好处或谈论我使用 Rust 的一般经验，因为我只有 30 分钟，而这一点可能已经超过了 30 分钟。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/05/STL%E8%AF%A6%E7%BB%86%E6%A2%B3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/05/STL%E8%AF%A6%E7%BB%86%E6%A2%B3%E7%90%86/" class="post-title-link" itemprop="url">STL详细梳理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-05 20:26:36 / 修改时间：20:43:26" itemprop="dateCreated datePublished" datetime="2024-09-05T20:26:36+08:00">2024-09-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E7%A8%8B%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">工程开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E7%A8%8B%E5%BC%80%E5%8F%91/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="STL-container"><a href="#STL-container" class="headerlink" title="STL-container"></a>STL-container</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/09/05/STL%E8%AF%A6%E7%BB%86%E6%A2%B3%E7%90%86/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://yimaginer.github.io/2024/09/05/linux%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus2flow">
      <meta itemprop="description" content="技术，人生，思考，自我">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Focus2flow">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/05/linux%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">linux 系统数据结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-05 20:26:36 / 修改时间：21:02:44" itemprop="dateCreated datePublished" datetime="2024-09-05T20:26:36+08:00">2024-09-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>linux 系统中常见的数据结构</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/09/05/linux%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">sky</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
